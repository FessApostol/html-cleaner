<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Очищувач HTML (MVP) — версія 17</title>

  <style>
    /* ===== Базові змінні теми ===== */
    :root { --gap: 14px; --code-font-size: 14px; }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
           background: #0b1020; color: #e7ecf7; }
    header { padding: 14px 18px; border-bottom: 1px solid #1b2445; background: #0f1630; position: sticky; top: 0; z-index: 5; }
    header h1 { margin: 0; font-size: 18px; font-weight: 600; }

    .wrap { padding: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }

    /* ===== Панелі редактора ===== */
    .panel { background: #0f1630; border: 1px solid #1b2445; border-radius: 10px; display: flex; flex-direction: column; min-height: 380px; overflow: hidden; }
    .panel h2 { margin: 0; padding: 12px 12px; font-size: 14px; border-bottom: 1px solid #1b2445; background: #121a3a; }

    /* ===== Тулбар форматування ===== */
    .toolbar { display: flex; flex-wrap: wrap; gap: 6px; padding: 10px 10px 8px; border-bottom: 1px solid #1b2445; background: #0e1431; }
    .toolbar button, .toolbar select { background: #16224a; color: #e7ecf7; border: 1px solid #2a3a78; border-radius: 8px; padding: 6px 10px; font-size: 13px; cursor: pointer; }
    .toolbar button:hover, .toolbar select:hover { background: #1a2958; }
    .toolbar button:active { transform: translateY(1px); }

    /* ===== Ліва панель (WYSIWYG). Примусово світлий текст для контрасту в нічній темі ===== */
    #editor { padding: 12px; height: 520px; outline: none; line-height: 1.5; overflow: auto; resize: vertical; }
    #editor:empty:before{ content: 'Вставте або напишіть текст тут…'; color:#8da0d0; }
    /* ВАЖЛИВО: у нічній темі кольори з Word/GDocs можуть бути темними — примусово робимо світлий текст лише всередині редактора */
    #editor, #editor * { color: #e9eefc !important; }

    /* ===== Права панель (HTML) ===== */
    #code { width: 100%; padding: 12px; height: 520px; background: #0a112b; color: #d7e1ff; border: 0; resize: vertical; outline: none; overflow: auto;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: var(--code-font-size); line-height: 1.5; }

    .foot-btns { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #1b2445; background: #0e1431; }
    .btn { background: #2952ff; border: 1px solid #4669ff; color: #fff; padding: 9px 12px; border-radius: 10px; font-size: 14px; cursor: pointer; }
    .btn.secondary { background: #16224a; border-color:#2a3a78; color:#e7ecf7; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }

    /* ===== Нижні картки ===== */
    .lower { grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .card { background: #0f1630; border: 1px solid #1b2445; border-radius: 10px; padding: 10px 12px 6px; }
    .card h3 { margin: 4px 0 10px; font-size: 14px; font-weight: 600; }
    .card .sub { display:block; margin-top:-6px; margin-bottom:8px; opacity:.8; font-size:12px; }

    .options { columns: 2; column-gap: 22px; }
    .options label { display: block; break-inside: avoid; margin: 6px 0; font-size: 13px; cursor: pointer; white-space: normal; word-break: break-word; }
    .options input { margin-right: 6px; }

    /* Білий список тегів */
    .wl-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .wl-block { padding:8px; border:1px dashed #243268; border-radius:8px; }
    .wl-block h4 { margin:0 0 6px; font-size:13px; opacity:.9; }
    .wl-list label { display:block; font-size:13px; margin:6px 0; }
    .wl-disabled { opacity:.55; pointer-events:none; }

    .find-row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; margin: 8px 0; }
    .find-row input { background: #0a112b; color:#e7ecf7; border:1px solid #2a3a78; border-radius:8px; padding:8px 10px; font-size:13px; }
    .hr { border-top: 1px dashed #26325f; margin: 10px 0; }

    @media (max-width: 1100px) { .wrap { grid-template-columns: 1fr; } .lower { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Очищувач HTML (MVP) — версія 17</h1>
  </header>

  <main class="wrap">
    <!-- ===== ЛІВА ПАНЕЛЬ: WYSIWYG редактор (коментарі українською) ===== -->
    <section class="panel" aria-label="Текст">
      <h2>Текст</h2>
      <div class="toolbar" aria-label="Засоби форматування">
        <select id="blockFormat" title="Формат блоку">
          <option value="p">Абзац</option>
          <option value="h1">H1</option>
          <option value="h2">H2</option>
          <option value="h3">H3</option>
          <option value="blockquote">Цитата</option>
          <option value="pre">Pre</option>
        </select>
        <select id="fontSize" title="Розмір шрифту">
          <option value="">Розмір</option>
          <option value="2">Малий</option>
          <option value="3">Звичайний</option>
          <option value="4">Середній</option>
          <option value="5">Великий</option>
        </select>
        <button type="button" data-cmd="bold"><b>B</b></button>
        <button type="button" data-cmd="italic"><i>I</i></button>
        <button type="button" data-cmd="underline"><u>U</u></button>
        <button type="button" data-cmd="strikeThrough" title="Закреслений">S</button>
        <button type="button" data-cmd="superscript" title="Надрядковий">x²</button>
        <button type="button" data-cmd="subscript" title="Підрядковий">x₂</button>
        <button type="button" data-cmd="justifyLeft" title="Вирівняти ліворуч">⟸</button>
        <button type="button" data-cmd="justifyCenter" title="По центру">≡</button>
        <button type="button" data-cmd="justifyRight" title="Вирівняти праворуч">⟹</button>
        <button type="button" data-cmd="justifyFull" title="По ширині">↔</button>
        <button type="button" data-cmd="insertUnorderedList">• Список</button>
        <button type="button" data-cmd="insertOrderedList">1. Список</button>
        <button type="button" data-cmd="outdent" title="Зменшити відступ">◁</button>
        <button type="button" data-cmd="indent" title="Збільшити відступ">▷</button>
        <button type="button" id="mkLink">Посилання</button>
        <button type="button" id="rmLink">Прибрати посилання</button>
        <button type="button" id="insImg" title="Вставити зображення">Зображення</button>
        <button type="button" id="clearFmt" title="Очистити форматування">Очистити</button>
      </div>
      <div id="editor" contenteditable="true"></div>
    </section>

    <!-- ===== ПРАВА ПАНЕЛЬ: HTML-код ===== -->
    <section class="panel" aria-label="HTML-код">
      <h2>HTML-код</h2>
      <textarea id="code" spellcheck="false" placeholder="Тут з’явиться HTML…"></textarea>
      <div class="foot-btns">
        <button class="btn" id="btnClean">Очистити</button>
        <button class="btn secondary" id="btnUndo" disabled>Назад</button>
        <button class="btn secondary" id="fontPlus" title="Збільшити шрифт">A+</button>
        <button class="btn secondary" id="fontMinus" title="Зменшити шрифт">A−</button>
        <button class="btn" id="btnCopy">Копіювати</button>
      </div>
    </section>

    <!-- ===== НИЖНІ КАРТКИ ===== -->
    <section class="lower">
      <!-- Опції очищення -->
      <div class="card">
        <h3>Опції очищення</h3>
        <div class="options" id="options">
          <label><input type="checkbox" id="opt-remove-attrs"> Видалити всі атрибути тегів</label>
          <label><input type="checkbox" id="opt-remove-inline"> Видалити inline-стилі</label>
          <label><input type="checkbox" id="opt-remove-class-id"> Прибрати класи та ID</label>
          <label><input type="checkbox" id="opt-remove-empty"> Видалити порожні теги</label>
          <label><input type="checkbox" id="opt-remove-one-nbsp"> Видалити теги, що містять лише &amp;nbsp;</label>
          <label><input type="checkbox" id="opt-nbsp-to-space"> Замінити &amp;nbsp; на пробіл (+ звести послідовність до 1)</label>
          <label><input type="checkbox" id="opt-remove-links"> Видалити посилання (залишити текст)</label>
          <label><input type="checkbox" id="opt-remove-images"> Видалити зображення</label>
          <label><input type="checkbox" id="opt-remove-tables"> Розгорнути таблиці (залишити вміст)</label>
          <label><input type="checkbox" id="opt-strong-to-h2"> Замінити &lt;strong&gt; на &lt;h2&gt;</label>
          <label><input type="checkbox" id="opt-em-to-h3"> Замінити &lt;em&gt;/&lt;i&gt; на &lt;h3&gt;</label>
        </div>
      </div>

      <!-- Білий список тегів -->
      <div class="card" id="wlCard">
        <h3>Залишити Білий список тегів</h3>
        <span class="sub">(коли ввімкнено — залишимо тільки обрані теги, решту розгорнемо)</span>
        <label style="display:block; margin-bottom:8px;">
          <input type="checkbox" id="opt-wl-enable"> Увімкнути Білий список
        </label>

        <div id="wlBox" class="wl-grid wl-disabled" aria-disabled="true">
          <div class="wl-block">
            <h4>Текст та заголовки</h4>
            <div class="wl-list">
              <label><input type="checkbox" class="wl" value="p"   checked> &lt;p&gt; — абзац</label>
              <label><input type="checkbox" class="wl" value="h1"  checked> &lt;h1&gt; — заголовок 1</label>
              <label><input type="checkbox" class="wl" value="h2"  checked> &lt;h2&gt; — заголовок 2</label>
              <label><input type="checkbox" class="wl" value="h3"  checked> &lt;h3&gt; — заголовок 3</label>
              <label><input type="checkbox" class="wl" value="strong" checked> &lt;strong&gt; — жирний</label>
              <label><input type="checkbox" class="wl" value="em"  checked> &lt;em&gt; — курсив</label>
              <label><input type="checkbox" class="wl" value="a"   checked> &lt;a&gt; — посилання</label>
            </div>
          </div>
          <div class="wl-block">
            <h4>Списки</h4>
            <div class="wl-list">
              <label><input type="checkbox" class="wl" value="ul"  checked> &lt;ul&gt; — маркований список</label>
              <label><input type="checkbox" class="wl" value="ol"  checked> &lt;ol&gt; — нумерований список</label>
              <label><input type="checkbox" class="wl" value="li"  checked> &lt;li&gt; — пункт списку</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Пошук/Заміна -->
      <div class="card" style="grid-column: 1 / -1;">
        <h3>Пошук і заміна у вихідному HTML</h3>
        <span class="sub">Виконується після очищення; поля <b>чутливі до регістру</b>.</span>
        <div id="findBox"></div>
        <button class="btn secondary" id="btnAddRow">+ Додати поле</button>
      </div>
    </section>
  </main>

  <script>
    /* =========================
       Посилання на елементи
       ========================= */
    const editor = document.getElementById('editor');
    const codeArea = document.getElementById('code');
    const undoBtn = document.getElementById('btnUndo');
    const blockFormat = document.getElementById('blockFormat');
    const fontSize = document.getElementById('fontSize');
    const mkLink = document.getElementById('mkLink');
    const rmLink = document.getElementById('rmLink');
    const insImg = document.getElementById('insImg');
    const clearFmt = document.getElementById('clearFmt');
    const fontPlus = document.getElementById('fontPlus');
    const fontMinus = document.getElementById('fontMinus');
    const btnCopy = document.getElementById('btnCopy');

    // Білий список
    const wlEnable = document.getElementById('opt-wl-enable');
    const wlBox = document.getElementById('wlBox');
    const wlChecks = () => Array.from(wlBox.querySelectorAll('input.wl'));

    // --- Тулбар: базові команди форматування ---
    document.querySelectorAll('.toolbar [data-cmd]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.execCommand(btn.dataset.cmd, false);
        editor.focus(); syncToCode();
      });
    });

    blockFormat.addEventListener('change', () => {
      document.execCommand('formatBlock', false, blockFormat.value);
      editor.focus(); syncToCode();
    });

    fontSize.addEventListener('change', () => {
      if (!fontSize.value) return;
      document.execCommand('fontSize', false, fontSize.value);
      syncToCode();
    });

    mkLink.addEventListener('click', () => {
      const url = prompt('Посилання (URL):','https://');
      if (!url) return; document.execCommand('createLink', false, url); syncToCode();
    });
    rmLink.addEventListener('click', () => { document.execCommand('unlink'); syncToCode(); });

    insImg.addEventListener('click', () => {
      const url = prompt('URL зображення:','https://');
      if (!url) return; document.execCommand('insertImage', false, url); syncToCode();
    });

    clearFmt.addEventListener('click', () => {
      document.execCommand('removeFormat');
      editor.querySelectorAll('span').forEach(s => s.replaceWith(...s.childNodes)); // розгортаємо span
      syncToCode();
    });

    // Живе дзеркало HTML (ліворуч → праворуч)
    function syncToCode(){ codeArea.value = prettyHtml(editor.innerHTML); }
    editor.addEventListener('input', syncToCode);
    editor.addEventListener('paste', () => setTimeout(syncToCode));
    // І навпаки: редагуєш код — одразу бачиш ліворуч
    codeArea.addEventListener('input', () => { editor.innerHTML = codeArea.value; });

    // Керування розміром шрифту коду
    function updateCodeFont(delta){
      const cs = getComputedStyle(document.documentElement).getPropertyValue('--code-font-size').trim();
      const px = parseInt(cs || '14', 10) + delta;
      document.documentElement.style.setProperty('--code-font-size', Math.max(10, Math.min(28, px)) + 'px');
    }
    fontPlus.addEventListener('click', () => updateCodeFont(+1));
    fontMinus.addEventListener('click', () => updateCodeFont(-1));

    // Копіювання
    btnCopy.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(codeArea.value);
        btnCopy.textContent = 'Скопійовано!';
        setTimeout(()=>btnCopy.textContent='Копіювати', 1200);
      } catch(e){
        codeArea.select(); document.execCommand('copy');
      }
    });

    // Undo для поля коду
    const undoStack = [];
    function pushUndo(){ undoStack.push(codeArea.value); undoBtn.disabled = false; }
    undoBtn.addEventListener('click', () => {
      if (!undoStack.length) return;
      codeArea.value = undoStack.pop();
      if (!undoStack.length) undoBtn.disabled = true;
      editor.innerHTML = codeArea.value;
    });

    // UI «Пошук/Заміна»
    const findBox = document.getElementById('findBox');
    function addFindRow(findVal = '', replVal = ''){
      const row = document.createElement('div');
      row.className = 'find-row';
      row.innerHTML =
        `<input type="text" placeholder="Що знайти" value="${findVal.replaceAll('"','&quot;')}">`+
        `<input type="text" placeholder="На що замінити" value="${replVal.replaceAll('"','&quot;')}">`+
        `<button class="btn secondary" type="button">Видалити</button>`;
      row.lastElementChild.addEventListener('click', () => row.remove());
      findBox.appendChild(row);
    }
    document.getElementById('btnAddRow').addEventListener('click', () => addFindRow());
    addFindRow();

    // Утиліти по DOM
    function unwrap(el){
      const p = el.parentNode; if (!p) return;
      while(el.firstChild) p.insertBefore(el.firstChild, el);
      p.removeChild(el);
    }
    function replaceTag(el, tag){
      const neo = el.ownerDocument.createElement(tag);
      while(el.firstChild) neo.appendChild(el.firstChild);
      el.replaceWith(neo); return neo;
    }
    function queryAll(root, sel){ return Array.from(root.querySelectorAll(sel)); }

    // Форматування HTML: «в рядок», без зайвих переносів
    function prettyHtml(html){
      try{
        html = String(html);
        // Розбиваємо на токени
        const tokens = [];
        let i = 0;
        while(i < html.length){
          const lt = html.indexOf('<', i);
          if (lt < 0){ const tail = html.slice(i); if (tail.trim()) tokens.push(tail); break; }
          const text = html.slice(i, lt);
          if (text.trim()) tokens.push(text);
          const gt = html.indexOf('>', lt+1);
          if (gt < 0){ tokens.push(html.slice(lt)); break; }
          tokens.push(html.slice(lt, gt+1));
          i = gt + 1;
        }
        const isTag = t => t.startsWith('<') && t.endsWith('>');
        const isClose = t => isTag(t) && t[1]==='/';
        const nameOf = t => { let j = t[1]==='/'?2:1, n=''; for(;j<t.length;j++){ const c=t[j]; if(c===' '||c==='>'||c==='/') break; n+=c; } return n.toLowerCase(); };
        const isSelf = t => /\/>$/.test(t);
        const voidSet = new Set(['br','hr','img','input','meta','link','source','track','wbr','area','base','col','embed','param']);
        const blockSet = new Set(['html','head','body','div','p','h1','h2','h3','h4','h5','h6','ul','ol','li','table','thead','tbody','tfoot','tr','td','th','section','article','header','footer','nav','blockquote','pre','figure','figcaption']);

        const out = []; let indent = 0;
        for(let k=0;k<tokens.length;k++){
          const t = tokens[k];

          // Випадок «відкриваючий блок + текст + закриваючий того ж блоку» → в один рядок.
          if (isTag(t)){
            const nm = nameOf(t);
            const isBlock = blockSet.has(nm);
            const selfc = isSelf(t) || voidSet.has(nm);
            const nxt = tokens[k+1], nxt2 = tokens[k+2];
            if (!isClose(t) && isBlock && !selfc && nxt && nxt2 && !isTag(nxt) && isTag(nxt2) && nameOf(nxt2)===nm){
              out.push('  '.repeat(indent) + t + nxt.trim() + nxt2);
              k += 2;
              continue;
            }
            if (isClose(t) && isBlock) indent = Math.max(0, indent-1);
            out.push('  '.repeat(indent) + t);
            if (!isClose(t) && isBlock && !selfc) indent++;
          } else {
            const text = t.trim();
            if (text) out.push('  '.repeat(indent) + text);
          }
        }
        return out.join('\n').replace(/\n{3,}/g, '\n\n').trim();
      }catch(e){ return String(html); }
    }

    /* =========================
       Білий список — UI
       ========================= */
    function refreshWhitelistUI(){
      const on = wlEnable.checked;
      wlBox.classList.toggle('wl-disabled', !on);
      wlChecks().forEach(cb => cb.disabled = !on);
    }
    wlEnable.addEventListener('change', refreshWhitelistUI);
    refreshWhitelistUI();

    /* =========================
       Основний пайплайн «Очистити»
       ========================= */
    document.getElementById('btnClean').addEventListener('click', () => {
      pushUndo();
      let html = codeArea.value || editor.innerHTML || '';

      // Парсимо у DOM
      const parser = new DOMParser();
      const doc = parser.parseFromString(`<div id="__root">${html}</div>`, 'text/html');
      const root = doc.getElementById('__root');

      // Опції
      const opts = {
        removeAttrs:        document.getElementById('opt-remove-attrs').checked,
        removeInline:       document.getElementById('opt-remove-inline').checked,
        removeClassId:      document.getElementById('opt-remove-class-id').checked,
        removeEmpty:        document.getElementById('opt-remove-empty').checked,
        removeOneNbsp:      document.getElementById('opt-remove-one-nbsp').checked,
        nbspToSpace:        document.getElementById('opt-nbsp-to-space').checked,
        removeLinks:        document.getElementById('opt-remove-links').checked,
        removeImages:       document.getElementById('opt-remove-images').checked,
        removeTables:       document.getElementById('opt-remove-tables').checked,
        strongToH2:         document.getElementById('opt-strong-to-h2').checked,
        emToH3:             document.getElementById('opt-em-to-h3').checked,
        wlEnabled:          wlEnable.checked
      };

      // 1) Структурні дії
      if (opts.removeImages) queryAll(root, 'img').forEach(el => el.remove());
      if (opts.removeLinks)  queryAll(root, 'a').forEach(el => unwrap(el));
      if (opts.removeTables) queryAll(root, 'table, thead, tbody, tfoot, tr, td, th').forEach(el => unwrap(el));

      if (opts.removeInline) queryAll(root, '[style]').forEach(el => el.removeAttribute('style'));
      if (opts.removeClassId){
        queryAll(root,'[class]').forEach(el=>el.removeAttribute('class'));
        queryAll(root,'[id]').forEach(el=>el.removeAttribute('id'));
      }
      if (opts.removeAttrs) queryAll(root,'*').forEach(el => { [...el.attributes].forEach(a=>el.removeAttribute(a.name)); });

      if (opts.strongToH2) queryAll(root, 'strong').forEach(el => replaceTag(el,'h2'));
      if (opts.emToH3)     queryAll(root, 'em, i').forEach(el => replaceTag(el,'h3'));

      // 2) Білий список — лишаємо тільки обрані теги (решту розгортаємо)
      if (opts.wlEnabled){
        const allowed = new Set(wlChecks().filter(cb=>cb.checked).map(cb=>cb.value));

        // Проходимо всі елементи глибинно і розгортаємо те, що не дозволено
        const walker = doc.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null);
        const toFix = [];
        for (let n = walker.nextNode(); n; n = walker.nextNode()){
          if (n === root) continue;
          toFix.push(n);
        }
        // Спочатку від найглибших — щоб не збивати ітерацію
        toFix.reverse().forEach(el => {
          const tag = el.tagName.toLowerCase();
          if (!allowed.has(tag)){
            // особливі інлайни типу <span>, <font> і т.п. — просто розгортаємо
            unwrap(el);
          }
        });

        // Огортаємо "голі" текстові вузли верхнього рівня у <p>, щоб рядки не лишались без тегів
        Array.from(root.childNodes).forEach(node=>{
          if (node.nodeType===3 && node.nodeValue.trim()!==''){
            const p = doc.createElement('p'); p.textContent = node.nodeValue; node.replaceWith(p);
          }
        });
      }

      // 3) Текстові заміни в HTML
      html = root.innerHTML;

      if (opts.nbspToSpace){
        html = html.replace(/&nbsp;|\u00A0/g, ' ');   // NBSP → пробіл
        html = html.replace(/ {2,}/g, ' ');          // послідовність пробілів → 1
      }
      if (opts.removeOneNbsp){
        // після попереднього кроку залишатимуться тільки пробіли — порожні елементи приберемо нижче
        const tmp = parser.parseFromString(`<div>${html}</div>`, 'text/html');
        const tmpRoot = tmp.body.firstElementChild;
        let changed;
        do{
          changed = false;
          queryAll(tmpRoot,'*').forEach(el=>{
            if (!el.firstElementChild && (el.textContent||'').trim()===''){ el.remove(); changed = true; }
          });
        }while(changed);
        html = tmpRoot.innerHTML;
      }

      // 4) Пошук/Заміна
      const rows = Array.from(findBox.querySelectorAll('.find-row'));
      for (const row of rows) {
        const [findInput, replInput] = row.querySelectorAll('input');
        const find = findInput.value; if (!find) continue; const repl = replInput.value;
        const esc = find.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        html = html.replace(new RegExp(esc, 'g'), repl);
      }

      // 5) Вивід
      codeArea.value = prettyHtml(html);
      editor.innerHTML = codeArea.value; // оновимо і ліву панель, щоб все було синхронно
    });

    // Початковий текст-підказка
    editor.innerHTML = '<p><strong>Ласкаво просимо!</strong> Вставте текст ліворуч. Праворуч з’явиться HTML-код. Оберіть опції очищення і натисніть <em>Очистити</em>.</p>';
    syncToCode();
  </script>
</body>
</html>
