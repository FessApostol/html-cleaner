<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Очищувач HTML (MVP) — версія 18</title>
  <style>
    :root{--gap:14px;--code-font-size:14px;--bg:#0b1020;--panel:#0f1630;--panel2:#121a3a;--line:#1b2445;--ink:#e7ecf7;--muted:#96a4c7;--btn:#2952ff;--btn2:#16224a;--btn2b:#2a3a78}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{padding:14px 18px;border-bottom:1px solid var(--line);background:#0f1630;position:sticky;top:0;z-index:5}
    header h1{margin:0;font-size:18px;font-weight:600}
    .wrap{padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}

    .panel{background:var(--panel);border:1px solid var(--line);border-radius:10px;display:flex;flex-direction:column;min-height:380px;overflow:hidden}
    .panel h2{margin:0;padding:12px 12px;font-size:14px;border-bottom:1px solid var(--line);background:var(--panel2)}
    .toolbar{display:flex;flex-wrap:wrap;gap:6px;padding:10px 10px 8px;border-bottom:1px solid var(--line);background:#0e1431}
    .toolbar button,.toolbar select{background:var(--btn2);color:var(--ink);border:1px solid var(--btn2b);border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}
    .toolbar button:hover,.toolbar select:hover{background:#1a2958}
    .toolbar button:active{transform:translateY(1px)}

    /* Лівий редактор. Важливо: робимо текст видимим навіть якщо всередині були темні інлайнові стилі */
    #editor{padding:12px;height:520px;outline:none;line-height:1.5;overflow:auto;resize:vertical}
    #editor:empty:before{content:'Вставте або напишіть текст тут…';color:#8da0d0}
    #editor *{color:var(--ink)!important}           /* <- прибиваємо темні inline-стилі від Word */
    #editor a{color:#91b4ff!important}

    /* Праве поле з кодом */
    #code{width:100%;padding:12px;height:520px;background:#0a112b;color:#d7e1ff;border:0;resize:vertical;outline:none;overflow:auto;
          font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:var(--code-font-size);line-height:1.5}

    .foot-btns{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line);background:#0e1431}
    .btn{background:var(--btn);border:1px solid #4669ff;color:#fff;padding:9px 12px;border-radius:10px;font-size:14px;cursor:pointer}
    .btn.secondary{background:var(--btn2);border-color:var(--btn2b);color:var(--ink)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .lower{grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:10px 12px 8px}
    .card h3{margin:4px 0 10px;font-size:14px;font-weight:600}
    .card .sub{display:block;margin:-6px 0 8px;opacity:.8;font-size:12px;color:var(--muted)}
    .options{columns:2;column-gap:22px}
    .options label{display:block;break-inside:avoid;margin:6px 0;font-size:13px;cursor:pointer}
    .options input{margin-right:6px}
    .hr{border-top:1px dashed #26325f;margin:10px 0}

    /* Білий список */
    .wl-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .wl-col h4{margin:6px 0 8px;font-size:13px;color:var(--muted);font-weight:600}
    .wl-col ul{list-style:disc;margin:0;padding-left:18px}
    .wl-col li{margin:4px 0}
    .wl-col label{cursor:pointer}
    .wl-muted{color:var(--muted);font-size:12px;margin:-2px 0 8px}

    @media (max-width:1100px){.wrap{grid-template-columns:1fr}.lower{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>Очищувач HTML (MVP) — версія 18</h1>
  </header>

  <main class="wrap">
    <!-- Ліва панель -->
    <section class="panel" aria-label="Текст">
      <h2>Текст</h2>
      <div class="toolbar" aria-label="Засоби форматування">
        <select id="blockFormat" title="Формат блоку">
          <option value="p">Абзац</option><option value="h1">H1</option><option value="h2">H2</option>
          <option value="h3">H3</option><option value="blockquote">Цитата</option><option value="pre">Pre</option>
        </select>
        <select id="fontSize" title="Розмір шрифту">
          <option value="">Розмір</option><option value="2">Малий</option><option value="3">Звичайний</option>
          <option value="4">Середній</option><option value="5">Великий</option>
        </select>
        <button type="button" data-cmd="bold"><b>B</b></button>
        <button type="button" data-cmd="italic"><i>I</i></button>
        <button type="button" data-cmd="underline"><u>U</u></button>
        <button type="button" data-cmd="strikeThrough" title="Закреслений">S</button>
        <button type="button" data-cmd="justifyLeft" title="Ліворуч">⟸</button>
        <button type="button" data-cmd="justifyCenter" title="По центру">≡</button>
        <button type="button" data-cmd="justifyRight" title="Праворуч">⟹</button>
        <button type="button" data-cmd="insertUnorderedList">• Список</button>
        <button type="button" data-cmd="insertOrderedList">1. Список</button>
        <button type="button" id="mkLink">Посилання</button>
        <button type="button" id="rmLink">Прибрати посилання</button>
        <button type="button" id="insImg">Зображення</button>
        <button type="button" id="clearFmt">Очистити</button>
      </div>
      <div id="editor" contenteditable="true"></div>
    </section>

    <!-- Права панель -->
    <section class="panel" aria-label="HTML-код">
      <h2>HTML-код</h2>
      <textarea id="code" spellcheck="false" placeholder="Тут з’явиться HTML…"></textarea>
      <div class="foot-btns">
        <button class="btn" id="btnClean">Очистити</button>
        <button class="btn secondary" id="btnUndo" disabled>Назад</button>
        <button class="btn secondary" id="fontPlus" title="A+">A+</button>
        <button class="btn secondary" id="fontMinus" title="A-">A−</button>
        <button class="btn" id="btnCopy">Копіювати</button>
      </div>
    </section>

    <!-- Нижні блоки -->
    <section class="lower">
      <div class="card">
        <h3>Опції очищення</h3>
        <div class="options" id="options">
          <label><input type="checkbox" id="opt-remove-inline"> Видалити inline-стилі</label>
          <label><input type="checkbox" id="opt-remove-class-id"> Прибрати класи та ID</label>
          <label><input type="checkbox" id="opt-remove-empty"> Видалити порожні теги</label>
          <label><input type="checkbox" id="opt-remove-one-nbsp"> Видалити теги, що містять лише &amp;nbsp;</label>
          <label><input type="checkbox" id="opt-remove-images"> Видалити зображення</label>
          <label><input type="checkbox" id="opt-remove-links"> Видалити посилання (залишити текст)</label>
          <label><input type="checkbox" id="opt-remove-tables"> Розгорнути таблиці (залишити вміст)</label>
          <label><input type="checkbox" id="opt-span-to-p"> Заміна &lt;div&gt;/&lt;span&gt; на &lt;p&gt;</label>
          <div class="hr"></div>
          <label><input type="checkbox" id="opt-nbsp-to-space"> Замінити &amp;nbsp; на пробіл (звести послідовності до одного)</label>
        </div>
      </div>

      <div class="card">
        <h3>Залишити Білий список тегів</h3>
        <span class="wl-muted">Коли увімкнено — залишимо тільки обрані теги, решту розгорнемо.</span>
        <label style="display:block;margin-bottom:8px">
          <input type="checkbox" id="wl-enabled"> Увімкнути Білий список
        </label>

        <div class="wl-grid">
          <div class="wl-col">
            <h4>Текст та заголовки</h4>
            <ul>
              <li><label><input type="checkbox" class="wl" id="wl-p"  checked> &lt;p&gt; — абзац</label></li>
              <li><label><input type="checkbox" class="wl" id="wl-h1" checked> &lt;h1&gt; — заголовок 1</label></li>
              <li><label><input type="checkbox" class="wl" id="wl-h2" checked> &lt;h2&gt; — заголовок 2</label></li>
              <li><label><input type="checkbox" class="wl" id="wl-h3" checked> &lt;h3&gt; — заголовок 3</label></li>
              <li><label><input type="checkbox" class="wl" id="wl-strong" checked> &lt;strong&gt; — жирний</label></li>
              <li><label><input type="checkbox" class="wl" id="wl-em" checked> &lt;em&gt; — курсив</label></li>
              <li><label><input type="checkbox" class="wl" id="wl-a" checked> &lt;a&gt; — посилання</label></li>
            </ul>
          </div>
          <div class="wl-col">
            <h4>Списки</h4>
            <ul>
              <li><label><input type="checkbox" class="wl" id="wl-ul" checked> &lt;ul&gt; — маркований список</label></li>
              <li><label><input type="checkbox" class="wl" id="wl-ol" checked> &lt;ol&gt; — нумерований список</label></li>
              <li><label><input type="checkbox" class="wl" id="wl-li" checked> &lt;li&gt; — пункт списку</label></li>
            </ul>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Пошук і заміна у вихідному HTML</h3>
        <span class="sub">Виконується після очищення; поля <b>чутливі до регістру</b>.</span>
        <div id="findBox"></div>
        <button class="btn secondary" id="btnAddRow">+ Додати поле</button>
      </div>
    </section>
  </main>

  <script>
    /* ===================== Посилання на елементи ===================== */
    const editor   = document.getElementById('editor');
    const codeArea = document.getElementById('code');
    const undoBtn  = document.getElementById('btnUndo');
    const btnCopy  = document.getElementById('btnCopy');
    const fontPlus = document.getElementById('fontPlus');
    const fontMinus= document.getElementById('fontMinus');
    const blockFormat = document.getElementById('blockFormat');
    const fontSize    = document.getElementById('fontSize');
    const mkLink = document.getElementById('mkLink');
    const rmLink = document.getElementById('rmLink');
    const insImg = document.getElementById('insImg');
    const clearFmt = document.getElementById('clearFmt');

    /* ===================== Тулбар ===================== */
    document.querySelectorAll('.toolbar [data-cmd]').forEach(b=>{
      b.addEventListener('click',()=>{document.execCommand(b.dataset.cmd,false); syncToCode(); editor.focus();});
    });
    blockFormat.addEventListener('change',()=>{document.execCommand('formatBlock',false,blockFormat.value); syncToCode();});
    fontSize.addEventListener('change',()=>{ if(!fontSize.value) return; document.execCommand('fontSize',false,fontSize.value); syncToCode(); });
    mkLink.addEventListener('click',()=>{const u=prompt('Посилання (URL):','https://'); if(!u) return; document.execCommand('createLink',false,u); syncToCode();});
    rmLink.addEventListener('click',()=>{document.execCommand('unlink'); syncToCode();});
    insImg.addEventListener('click',()=>{const u=prompt('URL зображення:','https://'); if(!u) return; document.execCommand('insertImage',false,u); syncToCode();});
    clearFmt.addEventListener('click',()=>{
      document.execCommand('removeFormat');
      editor.querySelectorAll('span').forEach(s=>s.replaceWith(...s.childNodes)); // розгортаємо зайві span
      syncToCode();
    });

    /* ===================== Двостороння синхронізація ===================== */
    editor.addEventListener('input', syncToCode);
    editor.addEventListener('paste', ()=>setTimeout(()=>{fixLoneMarksDOM(editor); syncToCode();},0));
    codeArea.addEventListener('input', ()=>{ editor.innerHTML = codeArea.value; });

    function syncToCode(){ codeArea.value = prettyHtml(editor.innerHTML); }

    /* ===================== Кнопки коду ===================== */
    const undoStack=[];
    function pushUndo(){ undoStack.push(codeArea.value); undoBtn.disabled=false; }
    undoBtn.addEventListener('click',()=>{ if(!undoStack.length) return; codeArea.value=undoStack.pop(); if(!undoStack.length) undoBtn.disabled=true; editor.innerHTML=codeArea.value; });
    btnCopy.addEventListener('click',async()=>{
      try{ await navigator.clipboard.writeText(codeArea.value); btnCopy.textContent='Скопійовано!'; setTimeout(()=>btnCopy.textContent='Копіювати',1200);}
      catch(e){ codeArea.select(); document.execCommand('copy'); }
    });
    function updateCodeFont(d){ const cur=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--code-font-size')||'14',10); document.documentElement.style.setProperty('--code-font-size',Math.max(10,Math.min(28,cur+d))+'px'); }
    fontPlus.addEventListener('click',()=>updateCodeFont(+1));
    fontMinus.addEventListener('click',()=>updateCodeFont(-1));

    /* ===================== Пошук/Заміна UI ===================== */
    const findBox = document.getElementById('findBox');
    function addFindRow(findVal='',replVal=''){
      const row=document.createElement('div'); row.className='find-row';
      row.innerHTML=`<input type="text" placeholder="Що знайти" value="${findVal.replaceAll('"','&quot;')}">`+
                    `<input type="text" placeholder="На що замінити" value="${replVal.replaceAll('"','&quot;')}">`+
                    `<button class="btn secondary" type="button">Видалити</button>`;
      row.lastElementChild.addEventListener('click',()=>row.remove());
      findBox.appendChild(row);
    }
    document.getElementById('btnAddRow').addEventListener('click',()=>addFindRow());
    addFindRow();

    /* ===================== Білий список: блокування чекбоксів ===================== */
    const wlEnabled = document.getElementById('wl-enabled');
    const wlBoxes = Array.from(document.querySelectorAll('.wl'));
    function setWLDisabled(){ wlBoxes.forEach(b=>b.disabled=!wlEnabled.checked); }
    wlEnabled.addEventListener('change', setWLDisabled); setWLDisabled();

    /* ===================== Утиліти DOM ===================== */
    function unwrap(el){ const p=el.parentNode; if(!p) return; while(el.firstChild) p.insertBefore(el.firstChild,el); p.removeChild(el); }
    function replaceTag(el,tag){ const n=document.createElement(tag); while(el.firstChild) n.appendChild(el.firstChild); el.replaceWith(n); return n; }
    function queryAll(root,sel){ return Array.from(root.querySelectorAll(sel)); }
    function rightmostTextNode(n){ if(!n) return null; if(n.nodeType===3) return n; for(let i=n.childNodes.length-1;i>=0;i--){ const t=rightmostTextNode(n.childNodes[i]); if(t) return t; } return null; }

    /* ===================== «Приклеювання» символів ® ™ © ℠ до слова зліва ===================== */
    function fixLoneMarksDOM(root){
      const marks=new Set(['®','™','©','℠']);
      const walker=document.createTreeWalker(root,NodeFilter.SHOW_ELEMENT,null);
      let node;
      while(node=walker.nextNode()){
        if(node.childNodes.length===1 && node.textContent && marks.has(node.textContent.trim())){
          const mark=node.textContent.trim();
          // шукаємо текстовий вузол ліворуч
          let prev=node.previousSibling, txt=rightmostTextNode(prev), up=node.parentNode;
          while(!txt && up){ prev=up.previousSibling; txt=rightmostTextNode(prev); up=up.parentNode; }
          if(txt){
            txt.data = txt.data.replace(/\s+$/,'') + mark;
            node.remove();
          } else {
            // якщо нема попереднього тексту — просто прибираємо зайві пробіли всередині
            node.textContent=mark;
          }
        }
      }
    }

    /* ===================== Форматування HTML-рядка ===================== */
    function prettyHtml(html){
      try{
        html=String(html);
        const tokens=[]; let i=0;
        while(i<html.length){
          const lt=html.indexOf('<',i);
          if(lt<0){ const tail=html.slice(i); if(tail.trim()) tokens.push(tail); break; }
          const text=html.slice(i,lt); if(text.trim()) tokens.push(text);
          const gt=html.indexOf('>',lt+1); if(gt<0){tokens.push(html.slice(lt));break;}
          tokens.push(html.slice(lt,gt+1)); i=gt+1;
        }
        const voidSet=new Set(['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr']);
        const blockSet=new Set(['html','head','body','div','p','h1','h2','h3','h4','h5','h6','ul','ol','li','table','thead','tbody','tfoot','tr','td','th','section','article','header','footer','nav','blockquote','pre','figure','figcaption','hr']);
        const isTag=t=>t.startsWith('<')&&t.endsWith('>');
        const tagName=tag=>{let j=tag[1]==='/'?2:1,name='';for(;j<tag.length;j++){const c=tag[j];if(c===' '||c==='>'||c==='/')break;name+=c;}return name.toLowerCase();}
        const isClose=tag=>tag[1]==='/'; const isSelf=tag=>tag[tag.length-2]==='/';
        let ind=0,out=[];
        for(const t of tokens){
          if(isTag(t)){ const n=tagName(t),close=isClose(t),self=isSelf(t)||voidSet.has(n),isBlock=blockSet.has(n);
            if(close&&isBlock) ind=Math.max(0,ind-1);
            out.push('  '.repeat(ind)+t);
            if(!close&&isBlock&&!self) ind++;
          }else{ const txt=t.replace(/\s+/g,' ').trim(); if(txt) out.push('  '.repeat(ind)+txt); }
        }
        return out.join('\n').trim();
      }catch(e){ return String(html); }
    }

    /* ===================== Головний пайплайн «Очистити» ===================== */
    document.getElementById('btnClean').addEventListener('click',()=>{
      pushUndo();

      // Беремо HTML з правого поля або зліва
      let html = codeArea.value || editor.innerHTML || '';

      // 0) Липкі символи (на всяк випадок — ще до парсингу рядком)
      html = html.replace(/\\s+([®™©℠])/g,'$1');

      // 1) Парсимо у DOM
      const parser=new DOMParser();
      const doc=parser.parseFromString(`<div id="__root">${html}</div>`,'text/html');
      const root=doc.getElementById('__root');

      // 1.1) Приклеюємо символи ® ™ © ℠, якщо вони в окремих елементах
      fixLoneMarksDOM(root);

      // 2) Читаємо опції
      const opts={
        removeInline: document.getElementById('opt-remove-inline').checked,
        removeClassId: document.getElementById('opt-remove-class-id').checked,
        removeEmpty: document.getElementById('opt-remove-empty').checked,
        removeOneNbsp: document.getElementById('opt-remove-one-nbsp').checked,
        removeImages: document.getElementById('opt-remove-images').checked,
        removeLinks: document.getElementById('opt-remove-links').checked,
        removeTables: document.getElementById('opt-remove-tables').checked,
        spanToP: document.getElementById('opt-span-to-p').checked,
        nbspToSpace: document.getElementById('opt-nbsp-to-space').checked,
        wlEnabled: document.getElementById('wl-enabled').checked
      };

      // 3) Базові структурні перетворення
      if(opts.removeImages) queryAll(root,'img').forEach(n=>n.remove());
      if(opts.removeLinks)  queryAll(root,'a').forEach(n=>unwrap(n));
      if(opts.removeTables) queryAll(root,'table,thead,tbody,tfoot,tr,td,th').forEach(n=>unwrap(n));
      if(opts.spanToP)      queryAll(root,'div,span').forEach(n=>replaceTag(n,'p'));

      if(opts.removeInline) queryAll(root,'[style]').forEach(n=>n.removeAttribute('style'));
      if(opts.removeClassId){ queryAll(root,'[class]').forEach(n=>n.removeAttribute('class')); queryAll(root,'[id]').forEach(n=>n.removeAttribute('id')); }

      // 4) Білий список
      if(opts.wlEnabled){
        const allow=new Set(
          ['p','h1','h2','h3','strong','em','a','ul','ol','li']
          .filter(tag=>document.getElementById('wl-'+tag).checked)
        );
        // Проходимо усі елементи і розгортаємо ті, яких нема в allow
        queryAll(root,'*').forEach(el=>{
          const name=el.tagName.toLowerCase();
          if(name==='div'||name==='span'){ // для див/спан краще одразу в <p> якщо абзаци дозволені
            if(allow.has('p')) replaceTag(el,'p'); else unwrap(el);
            return;
          }
          if(!allow.has(name)){
            // Якщо li/ul/ol не дозволені — приводимо пункти до абзаців, щоб не було «крапок»
            if((name==='li'||name==='ul'||name==='ol') && allow.has('p')){
              if(name==='li'){ replaceTag(el,'p'); }
              else { unwrap(el); }
            } else {
              unwrap(el);
            }
          }
        });
      }

      // 5) Загальна нормалізація P: розгортання вкладених, схлопування порожніх послідовностей
      (function normalizeP(){
        queryAll(root,'p p').forEach(inner=>unwrap(inner));
        const isBlank=el=>(!el.textContent || el.textContent.replace(/[\u00A0\s]/g,'')==='') && !el.firstElementChild;
        let changed;
        do{
          changed=false;
          const ps=queryAll(root,'p');
          for(let i=0;i<ps.length-1;i++){
            if(isBlank(ps[i])&&isBlank(ps[i+1])){ ps[i+1].remove(); changed=true; break; }
          }
        }while(changed);
      })();

      // 6) Серіалізуємо у рядок
      html = root.innerHTML;

      // 7) NBSP → пробіл (і звести послідовності до одного)
      if(opts.nbspToSpace){
        html = html.replace(/(?:&nbsp;|\u00A0)+/g,' ');
        html = html.replace(/ {2,}/g,' ');
      }

      // 8) Пошук/Заміна (буквальна, глобальна)
      const rows=Array.from(findBox.querySelectorAll('.find-row'));
      for(const r of rows){
        const [fInput, rInput]=r.querySelectorAll('input');
        if(!fInput.value) continue;
        const esc=fInput.value.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        html = html.replace(new RegExp(esc,'g'), rInput.value);
      }

      // 9) Вивід + двостороннє оновлення
      codeArea.value = prettyHtml(html);
      editor.innerHTML = codeArea.value;
    });

    /* ===================== Початковий контент ===================== */
    editor.innerHTML = '<p><strong>Ласкаво просимо!</strong> Вставте текст ліворуч — праворуч одразу з’явиться HTML. Оберіть опції й натисніть <em>Очистити</em>.</p>';
    syncToCode();
  </script>
</body>
</html>
