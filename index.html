<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
<title>–û—á–∏—â—É–≤–∞—á HTML (MVP) ‚Äî –≤–µ—Ä—Å—ñ—è 10</title>
  <style>
    /* ===== –¢–ï–ú–ò ===== */
    :root{
      --gap:14px; --code-font-size:14px;
      /* –Ω—ñ—á–Ω–∞ */
      --bg:#0b1020; --text:#e7ecf7; --muted:#8da0d0;
      --card:#0f1630; --card-2:#0e1431; --border:#1b2445; --border-2:#26325f;
      --mono:#0a112b; --btn:#2952ff; --btn2:#4669ff;
      --tok-tag:#5ab0ff; --tok-attr:#c792ea; --tok-str:#a3e635; --tok-punc:#9aa7c7; --tok-text:#e7ecf7;
    }
    body.theme-light{
      /* –¥–µ–Ω–Ω–∞ (—Å–≤—ñ—Ç–ª–∞ —è–∫ —É html-cleaner) */
      --bg:#ffffff; --text:#0b1220; --muted:#6b7280;
      --card:#ffffff; --card-2:#f5f7fb; --border:#dfe3ef; --border-2:#cfd6ea;
      --mono:#f8fafc; --btn:#2b72ff; --btn2:#5b8dff;
      --tok-tag:#005cc5; --tok-attr:#6f42c1; --tok-str:#22863a; --tok-punc:#6a737d; --tok-text:#24292e;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); }
    header{ padding:14px 18px; border-bottom:1px solid var(--border); background:var(--card);
            position:sticky; top:0; z-index:5; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    header h1{ margin:0; font-size:18px; font-weight:600; }
    #themeToggle{ background:var(--card-2); border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer; color:var(--text); }

    .wrap{ padding:16px; display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); }

    /* –ü–∞–Ω–µ–ª—ñ */
    .panel{ background:var(--card); border:1px solid var(--border); border-radius:10px; display:flex; flex-direction:column; min-height:380px; overflow:hidden; }
    .panel h2{ margin:0; padding:12px 12px; font-size:14px; border-bottom:1px solid var(--border); background:#121a3a; color:#e7ecf7; }
    body.theme-light .panel h2{ background:var(--card-2); color:inherit; }

    /* –¢—É–ª–±–∞—Ä */
    .toolbar{ display:flex; flex-wrap:wrap; gap:6px; padding:10px 10px 8px; border-bottom:1px solid var(--border); background:var(--card-2); }
    .toolbar button, .toolbar select{ background:#16224a; color:var(--text); border:1px solid #2a3a78; border-radius:8px; padding:6px 10px; font-size:13px; cursor:pointer; }
    body.theme-light .toolbar button, body.theme-light .toolbar select{ background:#fff; border-color:var(--border); color:inherit; }
    .toolbar button:hover, .toolbar select:hover{ filter:brightness(1.05); }
    .toolbar button:active{ transform:translateY(1px); }

    /* –†–µ–¥–∞–∫—Ç–æ—Ä */
    #editor{ padding:12px; height:520px; outline:none; line-height:1.5; overflow:auto; resize:vertical; }
    #editor:empty:before{ content:'–í—Å—Ç–∞–≤—Ç–µ –∞–±–æ –Ω–∞–ø–∏—à—ñ—Ç—å —Ç–µ–∫—Å—Ç —Ç—É—Ç‚Ä¶'; color:var(--muted); }

    /* –ü—Ä–∞–≤–µ –≤—ñ–∫–Ω–æ –∫–æ–¥—É (–∑ –ø—ñ–¥—Å–≤—ñ—Ç–∫–æ—é) */
    .code-wrap{ display:flex; flex-direction:column; }
    #codeRaw{ position:absolute; left:-99999px; }
    #codePre{ margin:0; background:var(--mono); color:var(--tok-text); padding:12px; height:520px; overflow:auto; resize:vertical;
              font:400 var(--code-font-size)/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; white-space:pre; }
    .tok.tag{ color:var(--tok-tag); } .tok.attr{ color:var(--tok-attr); }
    .tok.str{ color:var(--tok-str); } .tok.punc{ color:var(--tok-punc); }

    .foot-btns{ display:flex; gap:8px; padding:10px; border-top:1px solid var(--border); background:var(--card-2); }
    .btn{ background:var(--btn); border:1px solid var(--btn2); color:#fff; padding:9px 12px; border-radius:10px; font-size:14px; cursor:pointer; }
    .btn.secondary{ background:#16224a; border-color:#2a3a78; color:var(--text); }
    body.theme-light .btn.secondary{ background:#fff; border-color:var(--border); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    /* –ù–∏–∂–Ω—ñ –±–ª–æ–∫–∏ */
    .lower{ grid-column:1 / -1; display:grid; grid-template-columns:1fr 1fr; gap:var(--gap); }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:10px; padding:10px 12px 6px; }
    .card h3{ margin:4px 0 10px; font-size:14px; font-weight:600; }
    .card .sub{ display:block; margin-top:-6px; margin-bottom:8px; opacity:.8; font-size:12px; }
    .options{ columns:2; column-gap:22px; }
    .options label{ display:block; break-inside:avoid; margin:6px 0; font-size:13px; cursor:pointer; white-space:normal; word-break:break-word; }
    .options input{ margin-right:6px; }
    .find-row{ display:grid; grid-template-columns:1fr 1fr auto; gap:8px; margin:8px 0; }
    .find-row input{ background:var(--mono); color:var(--text); border:1px solid #2a3a78; border-radius:8px; padding:8px 10px; font-size:13px; }
    body.theme-light .find-row input{ background:#fff; color:inherit; border-color:var(--border); }
    .hr{ border-top:1px dashed var(--border-2); margin:10px 0; }

    @media (max-width:1100px){ .wrap{ grid-template-columns:1fr; } .lower{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>–û—á–∏—â—É–≤–∞—á HTML (MVP) ‚Äî –≤–µ—Ä—Å—ñ—è 8</h1>
    <button id="themeToggle" type="button">üåô –ù—ñ—á–Ω–∞ —Ç–µ–º–∞</button>
  </header>

  <main class="wrap">
    <!-- –õ—ñ–≤–∞ –ø–∞–Ω–µ–ª—å -->
    <section class="panel" aria-label="–¢–µ–∫—Å—Ç">
      <h2>–¢–µ–∫—Å—Ç</h2>
      <div class="toolbar" aria-label="–ó–∞—Å–æ–±–∏ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è">
        <select id="blockFormat" title="–§–æ—Ä–º–∞—Ç –±–ª–æ–∫—É">
          <option value="p">–ê–±–∑–∞—Ü</option>
          <option value="h1">H1</option><option value="h2">H2</option><option value="h3">H3</option>
          <option value="h4">H4</option><option value="blockquote">–¶–∏—Ç–∞—Ç–∞</option><option value="pre">Pre</option>
        </select>
        <button type="button" data-cmd="bold"><b>B</b></button>
        <button type="button" data-cmd="italic"><i>I</i></button>
        <button type="button" data-cmd="underline"><u>U</u></button>
        <button type="button" data-cmd="strikeThrough">S</button>
        <button type="button" data-cmd="superscript">x¬≤</button>
        <button type="button" data-cmd="subscript">x‚ÇÇ</button>
        <button type="button" data-cmd="justifyLeft">‚ü∏</button>
        <button type="button" data-cmd="justifyCenter">‚â°</button>
        <button type="button" data-cmd="justifyRight">‚üπ</button>
        <button type="button" data-cmd="justifyFull">‚Üî</button>
        <button type="button" data-cmd="insertUnorderedList">‚Ä¢ –°–ø–∏—Å–æ–∫</button>
        <button type="button" data-cmd="insertOrderedList">1. –°–ø–∏—Å–æ–∫</button>
        <button type="button" data-cmd="outdent">‚óÅ</button>
        <button type="button" data-cmd="indent">‚ñ∑</button>
        <button type="button" id="mkLink">–ü–æ—Å–∏–ª–∞–Ω–Ω—è</button>
        <button type="button" id="rmLink">–ü—Ä–∏–±—Ä–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</button>
        <button type="button" id="insImg">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è</button>
        <button type="button" id="clearFmt">–û—á–∏—Å—Ç–∏—Ç–∏</button>
      </div>
      <div id="editor" contenteditable="true"></div>
    </section>

    <!-- –ü—Ä–∞–≤–∞ –ø–∞–Ω–µ–ª—å -->
    <section class="panel" aria-label="HTML-–∫–æ–¥">
      <h2>HTML-–∫–æ–¥</h2>
      <div class="code-wrap">
        <textarea id="codeRaw" spellcheck="false"></textarea>
        <pre id="codePre"><code id="codeView"></code></pre>
      </div>
      <div class="foot-btns">
        <button class="btn" id="btnClean">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        <button class="btn secondary" id="btnUndo" disabled>–ù–∞–∑–∞–¥</button>
        <button class="btn secondary" id="fontPlus" title="–ó–±—ñ–ª—å—à–∏—Ç–∏ —à—Ä–∏—Ñ—Ç">A+</button>
        <button class="btn secondary" id="fontMinus" title="–ó–º–µ–Ω—à–∏—Ç–∏ —à—Ä–∏—Ñ—Ç">A‚àí</button>
        <button class="btn" id="btnCopy">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
      </div>
    </section>

    <!-- –ù–∏–∂–Ω—ñ –±–ª–æ–∫–∏ -->
    <section class="lower">
      <div class="card">
        <h3>–û–ø—Ü—ñ—ó –æ—á–∏—â–µ–Ω–Ω—è</h3>
        <div class="options">
          <label><input type="checkbox" id="opt-unwrap-except-p"> –ü—Ä–∏–±—Ä–∞—Ç–∏ –≤—Å—ñ —Ç–µ–≥–∏, –∫—Ä—ñ–º &lt;p&gt;</label>
          <label><input type="checkbox" id="opt-remove-inline"> –í–∏–¥–∞–ª–∏—Ç–∏ inline-—Å—Ç–∏–ª—ñ</label>
          <label><input type="checkbox" id="opt-remove-class-id"> –ü—Ä–∏–±—Ä–∞—Ç–∏ –∫–ª–∞—Å–∏ —Ç–∞ ID</label>
          <label><input type="checkbox" id="opt-remove-succ-nbsp"> –ü—Ä–∏–±—Ä–∞—Ç–∏ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ &amp;nbsp;</label>
          <label><input type="checkbox" id="opt-remove-empty"> –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ —Ç–µ–≥–∏</label>
          <label><input type="checkbox" id="opt-remove-one-nbsp"> –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–≥–∏, —â–æ –º—ñ—Å—Ç—è—Ç—å –ª–∏—à–µ &amp;nbsp;</label>
          <label><input type="checkbox" id="opt-remove-span"> –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–≥ &lt;span&gt;</label>
          <label><input type="checkbox" id="opt-remove-images"> –í–∏–¥–∞–ª–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
          <label><input type="checkbox" id="opt-remove-links"> –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è (–∑–∞–ª–∏—à–∏—Ç–∏ —Ç–µ–∫—Å—Ç)</label>
          <label><input type="checkbox" id="opt-remove-tables"> –†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ —Ç–∞–±–ª–∏—Ü—ñ (–∑–∞–ª–∏—à–∏—Ç–∏ –≤–º—ñ—Å—Ç)</label>
          <label><input type="checkbox" id="opt-table-to-empty-p"> –ó–∞–º—ñ–Ω–∏—Ç–∏ —Ç–µ–≥–∏ —Ç–∞–±–ª–∏—Ü—å –Ω–∞ –ø–æ—Ä–æ–∂–Ω—ñ &lt;p&gt;</label>
          <div class="hr"></div>
          <label><input type="checkbox" id="opt-remove-p-in-tables"> –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–≥–∏ &lt;p&gt; —É —Ç–∞–±–ª–∏—Ü—è—Ö</label>
          <label><input type="checkbox" id="opt-nbsp-to-space"> –ó–∞–º—ñ–Ω–∏—Ç–∏ &amp;nbsp; –Ω–∞ –ø—Ä–æ–±—ñ–ª</label>
          <label><input type="checkbox" id="opt-strong-to-h2"> –ó–∞–º—ñ–Ω–∏—Ç–∏ &lt;strong&gt; –Ω–∞ &lt;h2&gt;</label>
          <label><input type="checkbox" id="opt-em-to-h3"> –ó–∞–º—ñ–Ω–∏—Ç–∏ &lt;em&gt;/&lt;i&gt; –Ω–∞ &lt;h3&gt;</label>
        </div>
      </div>

      <div class="card">
        <h3>–ü–æ—à—É–∫ —ñ –∑–∞–º—ñ–Ω–∞ —É –≤–∏—Ö—ñ–¥–Ω–æ–º—É HTML</h3>
        <span class="sub">–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø—ñ—Å–ª—è –æ—á–∏—â–µ–Ω–Ω—è; –ø–æ–ª—è <b>—á—É—Ç–ª–∏–≤—ñ –¥–æ —Ä–µ–≥—ñ—Å—Ç—Ä—É</b>.</span>
        <div id="findBox"></div>
        <button class="btn secondary" id="btnAddRow">+ –î–æ–¥–∞—Ç–∏ –ø–æ–ª–µ</button>
      </div>
    </section>
  </main>

  <script>
    /* ===== –¢–µ–º–∞ ===== */
    (function initTheme(){
      const saved = localStorage.getItem('html-cleaner-theme');
      if (saved === 'light') document.body.classList.add('theme-light');
      updateThemeLabel();
      document.getElementById('themeToggle').addEventListener('click', () => {
        document.body.classList.toggle('theme-light');
        localStorage.setItem('html-cleaner-theme',
          document.body.classList.contains('theme-light') ? 'light' : 'dark');
        updateThemeLabel();
      });
      function updateThemeLabel(){
        document.getElementById('themeToggle').textContent =
          document.body.classList.contains('theme-light') ? 'üåû –î–µ–Ω–Ω–∞ —Ç–µ–º–∞' : 'üåô –ù—ñ—á–Ω–∞ —Ç–µ–º–∞';
      }
    })();

    /* ===== –ï–ª–µ–º–µ–Ω—Ç–∏ ===== */
    const editor   = document.getElementById('editor');
    const codeRaw  = document.getElementById('codeRaw');
    const codeView = document.getElementById('codeView');
    const blockFormat = document.getElementById('blockFormat');
    const mkLink   = document.getElementById('mkLink');
    const rmLink   = document.getElementById('rmLink');
    const insImg   = document.getElementById('insImg');
    const clearFmt = document.getElementById('clearFmt');
    const fontPlus = document.getElementById('fontPlus');
    const fontMinus= document.getElementById('fontMinus');
    const btnCopy  = document.getElementById('btnCopy');
    const undoBtn  = document.getElementById('btnUndo');

    /* ===== –¢—É–ª–±–∞—Ä ===== */
    document.querySelectorAll('.toolbar [data-cmd]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.execCommand(btn.dataset.cmd,false);
        normalizeEditorSemantic(); syncToCode();
      });
    });
    blockFormat.addEventListener('change', ()=>{
      document.execCommand('formatBlock', false, blockFormat.value);
      normalizeEditorSemantic(); syncToCode();
    });
    mkLink.addEventListener('click', ()=>{
      const url = prompt('–ü–æ—Å–∏–ª–∞–Ω–Ω—è (URL):','https://'); if(!url) return;
      document.execCommand('createLink', false, url);
      normalizeEditorSemantic(); syncToCode();
    });
    rmLink.addEventListener('click', ()=>{ document.execCommand('unlink'); normalizeEditorSemantic(); syncToCode(); });
    insImg.addEventListener('click', ()=>{
      const url = prompt('URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:','https://'); if(!url) return;
      document.execCommand('insertImage', false, url);
      normalizeEditorSemantic(); syncToCode();
    });
    clearFmt.addEventListener('click', ()=>{
      document.execCommand('removeFormat');
      editor.querySelectorAll('span').forEach(s=>s.replaceWith(...s.childNodes));
      normalizeEditorSemantic(); syncToCode();
    });

    /* ===== –ñ–∏–≤–∏–π –∫–æ–¥ + –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è ===== */
    const undoStack=[];
    function pushUndo(){ undoStack.push(codeRaw.value); undoBtn.disabled=false; }
    undoBtn.addEventListener('click', ()=>{ if(!undoStack.length) return; codeRaw.value=undoStack.pop(); renderHighlighted(); if(!undoStack.length) undoBtn.disabled=true; });

    function syncToCode(){ codeRaw.value = prettyFormat(editor.innerHTML); renderHighlighted(); }
    function renderHighlighted(){ codeView.innerHTML = highlightHtml(codeRaw.value); }

    // b‚Üístrong, i‚Üíem —É —Ä–µ–¥–∞–∫—Ç–æ—Ä—ñ
    function normalizeEditorSemantic(root = editor){
      root.querySelectorAll('b').forEach(el=>replaceTag(el,'strong'));
      root.querySelectorAll('i').forEach(el=>replaceTag(el,'em'));
      root.querySelectorAll('font').forEach(el=>replaceTag(el,'span'));
    }

    // ¬´–†–æ–∑—É–º–Ω–∞¬ª –≤—Å—Ç–∞–≤–∫–∞
    editor.addEventListener('paste',(e)=>{
      e.preventDefault();
      const html = (e.clipboardData||window.clipboardData).getData('text/html');
      const text = (e.clipboardData||window.clipboardData).getData('text/plain');
      let clean='';
      if (html) clean = sanitizePastedHTML(html);
      else clean = text.split(/\r?\n\r?\n/).map(p=>`<p>${p.replace(/\r?\n/g,'<br>')}</p>`).join('');
      document.execCommand('insertHTML', false, clean);
      normalizeEditorSemantic(); syncToCode();
    });
    editor.addEventListener('input', ()=>{ normalizeEditorSemantic(); syncToCode(); });

    /* ===== –†–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É –∫–æ–¥—É ===== */
    function updateCodeFont(delta){
      const pre = document.getElementById('codePre');
      const px = parseInt(getComputedStyle(pre).fontSize || '14', 10) + delta;
      pre.style.fontSize = Math.max(10, Math.min(28, px)) + 'px';
    }
    fontPlus.addEventListener('click', ()=>updateCodeFont(+1));
    fontMinus.addEventListener('click', ()=>updateCodeFont(-1));

    /* ===== –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è ===== */
    btnCopy.addEventListener('click', async()=>{
      try{ await navigator.clipboard.writeText(codeRaw.value); btnCopy.textContent='–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!'; setTimeout(()=>btnCopy.textContent='–ö–æ–ø—ñ—é–≤–∞—Ç–∏',1200); }
      catch(e){ codeRaw.select(); document.execCommand('copy'); }
    });

    /* ===== –ü–æ—à—É–∫/–∑–∞–º—ñ–Ω–∞ ===== */
    const findBox = document.getElementById('findBox');
    document.getElementById('btnAddRow').addEventListener('click', ()=>addFindRow());
    addFindRow();
    function addFindRow(findVal='',replVal=''){
      const row=document.createElement('div');
      row.className='find-row';
      row.innerHTML=`<input type="text" placeholder="–©–æ –∑–Ω–∞–π—Ç–∏" value="${findVal.replaceAll('"','&quot;')}">`+
                    `<input type="text" placeholder="–ù–∞ —â–æ –∑–∞–º—ñ–Ω–∏—Ç–∏" value="${replVal.replaceAll('"','&quot;')}">`+
                    `<button class="btn secondary" type="button">–í–∏–¥–∞–ª–∏—Ç–∏</button>`;
      row.lastElementChild.addEventListener('click',()=>row.remove());
      findBox.appendChild(row);
    }

    /* ===== –£—Ç–∏–ª—ñ—Ç–∏ DOM ===== */
    function unwrap(el){ const p=el.parentNode; if(!p) return; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); }
    function replaceTag(el,tag){ const neo=document.createElement(tag); while(el.firstChild) neo.appendChild(el.firstChild); el.replaceWith(neo); return neo; }
    function queryAll(root,sel){ return Array.from(root.querySelectorAll(sel)); }

    /* ===== –°–∞–Ω—ñ—Ç–∏–∑–∞—Ü—ñ—è –ø—Ä–∏ –≤—Å—Ç–∞–≤—Ü—ñ ===== */
    function sanitizePastedHTML(raw){
      const parser=new DOMParser();
      const doc=parser.parseFromString(`<div id="__root">${raw}</div>`,'text/html');
      const root=doc.getElementById('__root');
      root.querySelectorAll('script,style').forEach(n=>n.remove());
      root.querySelectorAll('b').forEach(n=>replaceTag(n,'strong'));
      root.querySelectorAll('i').forEach(n=>replaceTag(n,'em'));
      queryAll(root,'*').forEach(el=>{
        let bold=false, italic=false;
        if (el.hasAttribute('style')){
          const st=el.getAttribute('style');
          if (/(font-weight\s*:\s*(bold|[6-9]00))/i.test(st)) bold=true;
          if (/(font-style\s*:\s*italic)/i.test(st)) italic=true;
        }
        [...el.attributes].forEach(a=>{
          const n=a.name.toLowerCase();
          if (n==='style' || n==='class' || n==='id' || n==='dir' || n==='lang' || n==='width' || n==='height'
              || n.startsWith('data-') || n.startsWith('aria-') || n==='role'){
            el.removeAttribute(a.name);
          }
        });
        if (bold && italic){ const em=document.createElement('em'); while(el.firstChild) em.appendChild(el.firstChild);
          const strong=document.createElement('strong'); strong.appendChild(em); el.replaceWith(strong);
        } else if (bold){ replaceTag(el,'strong'); } else if (italic){ replaceTag(el,'em'); }
      });
      return root.innerHTML;
    }

    /* ===== –ü—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è HTML ===== */
    function escText(s){
      // –∫–æ–¥—É—î–º–æ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∏ —ñ NBSP ‚Üí &nbsp; (—â–æ–±–∏ –Ω–µ –≤—Ç—Ä–∞—á–∞—Ç–∏ —ó—Ö)
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/\u00A0/g,'&nbsp;');
    }
    function highlightHtml(src){
      let out=''; let i=0;
      while(i<src.length){
        const lt=src.indexOf('<',i);
        if(lt<0){ out+=escText(src.slice(i)); break; }
        if(lt>i) out+=escText(src.slice(i,lt));
        const gt=src.indexOf('>',lt+1); if(gt<0){ out+=escText(src.slice(lt)); break; }
        const tag=src.slice(lt,gt+1); out+=highlightTag(tag); i=gt+1;
      }
      return out;
    }
    function highlightTag(tag){
      const m=/^<\s*(\/)?\s*([a-zA-Z][\w:-]*)([^>]*)>$/s.exec(tag);
      if(!m) return escText(tag);
      const [,close,name,rest]=m;
      let html=`<span class="tok punc">&lt;${close?'/':''}</span><span class="tok tag">${name}</span>`;
      const attrRe=/([a-zA-Z_:][\w:.-]*)(\s*=\s*(?:"[^"]*"|'[^']*'|[^\s"'>=]+))?/g; let a;
      while((a=attrRe.exec(rest))){ const an=a[1], eq=a[2]||''; html+=` <span class="tok attr">${an}</span>`; if(eq){ const v=eq.replace(/^\s*=\s*/,''); html+=`<span class="tok punc">=</span><span class="tok str">${escText(v)}</span>`; } }
      html+=`<span class="tok punc">&gt;</span>`; return html;
    }

    /* ===== –§–æ—Ä–º–∞—Ç–µ—Ä ¬´–≤ —Ä—è–¥–æ–∫ –¥–ª—è —ñ–Ω–ª–∞–π–Ω—ñ–≤, –ø–µ—Ä–µ–Ω–æ—Å –¥–ª—è –±–ª–æ–∫—ñ–≤¬ª, –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è NBSP ===== */
    function prettyFormat(html){
      // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –ª–∏—à–µ \r\n, \t ‚Äî –ù–ï —á—ñ–ø–∞—î–º–æ –∑–≤–∏—á–∞–π–Ω—ñ –ø—Ä–æ–±—ñ–ª–∏ —Ç–∞ NBSP
      html = (html || '').replace(/[\r\n\t]/g, '');

      const parser = new DOMParser();
      const doc = parser.parseFromString(`<div id="__root">${html}</div>`, 'text/html');
      const root = doc.getElementById('__root');

      // –ì–ª–æ–±–∞–ª—å–Ω–æ: –≤—Å—ñ <div> –º—ñ–Ω—è—î–º–æ –Ω–∞ <p> (–∞—Ç—Ä–∏–±—É—Ç–∏ —ñ–≥–Ω–æ—Ä—É—î–º–æ)
queryAll(root, 'div').forEach(el => replaceTag(el, 'p'));

      const voidSet  = new Set(['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr']);
      const blockSet = new Set(['html','head','body','div','p','h1','h2','h3','h4','h5','h6','ul','ol','li','table','thead','tbody','tfoot','tr','td','th','section','article','header','footer','nav','blockquote','pre','figure','figcaption','hr']);
      const inlineSet= new Set(['a','span','strong','em','b','i','u','s','sub','sup','small','abbr','code','kbd','mark','q','cite','time','var','label','br','img']);
      const attrEsc = (s)=>String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      const textKeep = (s)=>escText(String(s).replace(/[\r\n\t]/g,'')); // NBSP –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è, –∑–≤–∏—á–∞–π–Ω—ñ –ø—Ä–æ–±—ñ–ª–∏ ‚Äî —è–∫ —î


      function openTag(el){
        let s = `<${el.nodeName.toLowerCase()}`;
        for (const a of el.attributes){ s += ` ${a.name}="${attrEsc(a.value)}"`; }
        return s + '>';
      }
      function closeTag(el){ return `</${el.nodeName.toLowerCase()}>`; }

      function onlyInlineInside(el){
        for (let n=el.firstChild; n; n=n.nextSibling){
          if (n.nodeType===1){
            const name=n.nodeName.toLowerCase();
            if (blockSet.has(name) && !inlineSet.has(name)) return false;
            if (!onlyInlineInside(n)) return false;
          }
        }
        return true;
      }

      function printNode(n, indent, out){
        if (n.nodeType===3){ // TEXT
          const t = textKeep(n.nodeValue);
          if (t) out.push('  '.repeat(indent) + t);
          return;
        }
        if (n.nodeType!==1) return;

        const name=n.nodeName.toLowerCase();
        if (voidSet.has(name)){ out.push('  '.repeat(indent) + openTag(n).replace('>',' />')); return; }

        const line = openTag(n);
        const inlineOnly = onlyInlineInside(n);

        if (inlineOnly){
          let inner='';
          for (let c=n.firstChild; c; c=c.nextSibling){
            if (c.nodeType===3) inner += textKeep(c.nodeValue);
            else if (c.nodeType===1){ const tmp=[]; printNodeInline(c,tmp); inner+=tmp.join(''); }
          }
          out.push('  '.repeat(indent) + line + inner + closeTag(n));
        } else {
          out.push('  '.repeat(indent) + line);
          for (let c=n.firstChild; c; c=c.nextSibling){ printNode(c, indent+1, out); }
          out.push('  '.repeat(indent) + closeTag(n));
        }
      }
      function printNodeInline(el, out){
        const name=el.nodeName.toLowerCase();
        if (voidSet.has(name)){ out.push(openTag(el).replace('>',' />')); return; }
        let s=openTag(el), inner='';
        for (let c=el.firstChild; c; c=c.nextSibling){
          if (c.nodeType===3) inner += textKeep(c.nodeValue);
          else if (c.nodeType===1){ const t=[]; printNodeInline(c,t); inner+=t.join(''); }
        }
        out.push(s+inner+closeTag(el));
      }

      const out=[];
      for (let n=root.firstChild; n; n=n.nextSibling){ printNode(n,0,out); }
      return out.join('\n').trim();
    }

    /* ===== –û—á–∏—â–µ–Ω–Ω—è ===== */
    document.getElementById('btnClean').addEventListener('click', ()=>{
      pushUndo();
      let html = codeRaw.value || editor.innerHTML || '';

      const parser=new DOMParser();
      const doc=parser.parseFromString(`<div id="__root">${html}</div>`,'text/html');
      const root=doc.getElementById('__root');

      const opts={
        unwrapExceptP: document.getElementById('opt-unwrap-except-p').checked,
        removeInline:document.getElementById('opt-remove-inline').checked,
        removeClassId:document.getElementById('opt-remove-class-id').checked,
        removeSuccNbsp:document.getElementById('opt-remove-succ-nbsp').checked,
        removeEmpty:document.getElementById('opt-remove-empty').checked,
        removeOneNbsp:document.getElementById('opt-remove-one-nbsp').checked,
        removeSpan: document.getElementById('opt-remove-span').checked,
        removeImages:document.getElementById('opt-remove-images').checked,
        removeLinks:document.getElementById('opt-remove-links').checked,
        removeTables:document.getElementById('opt-remove-tables').checked,
        tableToEmptyP:document.getElementById('opt-table-to-empty-p').checked,
        removePInTables:document.getElementById('opt-remove-p-in-tables').checked,
        nbspToSpace:document.getElementById('opt-nbsp-to-space').checked,
        strongToH2:document.getElementById('opt-strong-to-h2').checked,
        emToH3:document.getElementById('opt-em-to-h3').checked,
      };

      if (opts.removeImages) queryAll(root,'img').forEach(el=>el.remove());
      if (opts.removeLinks)  queryAll(root,'a').forEach(el=>unwrap(el));
      if (opts.removeSpan) queryAll(root, 'span').forEach(el => unwrap(el)); // –≤–∏–¥–∞–ª—è—î–º–æ –ª–∏—à–µ —Ç–µ–≥ <span>, –∑–∞–ª–∏—à–∞—é—á–∏ –≤–º—ñ—Å—Ç
    }
      if (opts.removePInTables) queryAll(root,'table p, thead p, tbody p, tr p, td p, th p').forEach(p=>unwrap(p));
      if (opts.strongToH2) queryAll(root,'strong').forEach(el=>replaceTag(el,'h2'));
      if (opts.emToH3)     queryAll(root,'em, i').forEach(el=>replaceTag(el,'h3'));
      if (opts.tableToEmptyP) queryAll(root,'table, thead, tbody, tr, td, th').forEach(el=>{ const p=document.createElement('p'); el.replaceWith(p); });
      if (opts.removeTables)  queryAll(root,'table, thead, tbody, tr, td, th').forEach(el=>unwrap(el));

      if (opts.removeInline)  queryAll(root,'[style]').forEach(el=>el.removeAttribute('style'));
      if (opts.removeClassId){ queryAll(root,'[class]').forEach(el=>el.removeAttribute('class')); queryAll(root,'[id]').forEach(el=>el.removeAttribute('id')); }
      if (opts.unwrapExceptP) {
  queryAll(root, '*').forEach(el => {
    if (el.nodeName.toLowerCase() !== 'p') unwrap(el);
  });
}

      // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ (–≤–∫–ª—é—á–Ω–æ –∑ ¬´<p><strong><em></em></strong></p>¬ª)
      if (opts.removeEmpty || opts.removeOneNbsp){
        const isMeaningless = (el) => {
          // NBSP –≤–≤–∞–∂–∞—î–º–æ ¬´–ø–æ—Ä–æ–∂–Ω–µ—á–µ—é¬ª —É —Ü—ñ–π –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ
          const text = (el.textContent || '').replace(/\u00A0|\s/g,'');
          // –Ω–µ –≤–∏–¥–∞–ª—è—î–º–æ, —è–∫—â–æ —î ¬´–≤—ñ–∑—É–∞–ª—å–Ω—ñ¬ª –µ–ª–µ–º–µ–Ω—Ç–∏
          if (el.querySelector && el.querySelector('img,br,hr,video,audio,iframe,svg,source')) return false;
          return text==='';
        };
        const onlyNbspInnerHTML = (el) => /^(\s|\u00A0|&nbsp;)*$/.test(el.innerHTML || '');
        let changed;
        do{
          changed=false;
          queryAll(root,'*').forEach(el=>{
            if (opts.removeEmpty && isMeaningless(el)){ el.remove(); changed=true; return; }
            if (opts.removeOneNbsp && !el.firstElementChild && onlyNbspInnerHTML(el)){ el.remove(); changed=true; }
          });
        }while(changed);
      }

      // –ù–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è <p>
      (function normalizeP(){
        queryAll(root,'p p').forEach(inner=>unwrap(inner));
        const isBlank=el=>(!el.textContent||el.textContent.replace(/\u00A0|\s/g,'')==='')&&!el.firstElementChild;
        let changed; do{
          changed=false;
          const ps=queryAll(root,'p');
          for(let i=0;i<ps.length-1;i++){ const a=ps[i], b=ps[i+1]; if(isBlank(a)&&isBlank(b)){ b.remove(); changed=true; break; } }
        }while(changed);
      })();

      html = root.innerHTML;
      if (opts.nbspToSpace)    html = html.replace(/&nbsp;|\u00A0/g,' ');
      if (opts.removeSuccNbsp) html = html.replace(/(?:&nbsp;|\u00A0){2,}/g,' ');

      // –ü–æ—à—É–∫/–∑–∞–º—ñ–Ω–∞ (–ª—ñ—Ç–µ—Ä–∞–ª—å–Ω–æ)
      const rows=Array.from(document.querySelectorAll('.find-row'));
      for(const row of rows){
        const [findInput,replInput]=row.querySelectorAll('input');
        const find=findInput.value; if(!find) continue;
        const repl=replInput.value;
        const esc=find.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        html=html.replace(new RegExp(esc,'g'), repl);
      }

      codeRaw.value = prettyFormat(html);
      renderHighlighted();
    });

    /* ===== –°—Ç–∞—Ä—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è ===== */
    editor.innerHTML = '<p><strong>–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!</strong> –í—Å—Ç–∞–≤—Ç–µ —Ç–µ–∫—Å—Ç –ª—ñ–≤–æ—Ä—É—á. –ü—Ä–∞–≤–æ—Ä—É—á –∑‚Äô—è–≤–∏—Ç—å—Å—è HTML-–∫–æ–¥. –û–±–µ—Ä—ñ—Ç—å –æ–ø—Ü—ñ—ó –æ—á–∏—â–µ–Ω–Ω—è —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å <em>–û—á–∏—Å—Ç–∏—Ç–∏</em>.</p>';
    normalizeEditorSemantic(); syncToCode();
  </script>
</body>
</html>
