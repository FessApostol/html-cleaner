<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Очищувач HTML (MVP) — версія 15</title>
  <style>
    :root { --gap: 14px; --code-font-size: 14px; }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #0b1020; color: #e7ecf7;
    }
    header { padding: 14px 18px; border-bottom: 1px solid #1b2445; background: #0f1630; position: sticky; top: 0; z-index: 5; }
    header h1 { margin: 0; font-size: 18px; font-weight: 600; }

    .wrap { padding: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }

    /* Панелі редактора */
    .panel { background: #0f1630; border: 1px solid #1b2445; border-radius: 10px; display: flex; flex-direction: column; min-height: 380px; overflow: hidden; }
    .panel h2 { margin: 0; padding: 12px 12px; font-size: 14px; border-bottom: 1px solid #1b2445; background: #121a3a; }

    /* Тулбар форматування */
    .toolbar { display: flex; flex-wrap: wrap; gap: 6px; padding: 10px 10px 8px; border-bottom: 1px solid #1b2445; background: #0e1431; }
    .toolbar button, .toolbar select { background: #16224a; color: #e7ecf7; border: 1px solid #2a3a78; border-radius: 8px; padding: 6px 10px; font-size: 13px; cursor: pointer; }
    .toolbar button:hover, .toolbar select:hover { background: #1a2958; }
    .toolbar button:active { transform: translateY(1px); }

    #editor { padding: 12px; height: 520px; outline: none; line-height: 1.5; overflow: auto; resize: vertical; color:#e7ecf7; }
    #editor:empty:before{ content: 'Вставте або напишіть текст тут…'; color:#8da0d0; }

    #code { width: 100%; padding: 12px; height: 520px; background: #0a112b; color: #d7e1ff;
      border: 0; resize: vertical; outline: none; overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: var(--code-font-size); line-height: 1.5; }

    .foot-btns { display: flex; gap: 8px; padding: 10px; border-top: 1px solid #1b2445; background: #0e1431; }
    .btn { background: #2952ff; border: 1px solid #4669ff; color: #fff; padding: 9px 12px; border-radius: 10px; font-size: 14px; cursor: pointer; }
    .btn.secondary { background: #16224a; border-color:#2a3a78; color:#e7ecf7; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }

    /* Нижній блок: опції + білий список + пошук/заміна */
    .lower { grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
    .card { background: #0f1630; border: 1px solid #1b2445; border-radius: 10px; padding: 10px 12px 8px; }
    .card h3 { margin: 4px 0 6px; font-size: 14px; font-weight: 600; }
    .card .sub { display:block; margin:-2px 0 8px; opacity:.8; font-size:12px; }

    .options { columns: 2; column-gap: 22px; }
    .options label { display: block; break-inside: avoid; margin: 6px 0; font-size: 13px; cursor: pointer; white-space: normal; word-break: break-word; }
    .options input { margin-right: 6px; }

    .wl-wrap .note { font-size:12px; opacity:.75; margin-bottom:8px; }
    .wl-list { display:grid; grid-template-columns: repeat(2,minmax(200px,1fr)); gap:6px 18px; list-style: disc; padding-left: 22px; margin: 8px 0 6px; }
    .wl-list li { margin: 2px 0; }
    .wl-list label { cursor:pointer; font-size:13px; }
    .wl-disabled .wl-list label { opacity:.55; pointer-events: none; }

    .find-row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; margin: 8px 0; }
    .find-row input { background: #0a112b; color:#e7ecf7; border:1px solid #2a3a78; border-radius:8px; padding:8px 10px; font-size:13px; }

    @media (max-width: 1100px) { .wrap { grid-template-columns: 1fr; } .lower { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>Очищувач HTML (MVP) — версія 15</h1>
  </header>

  <main class="wrap">
    <!-- ЛІВА ПАНЕЛЬ: текстовий редактор -->
    <section class="panel" aria-label="Текст">
      <h2>Текст</h2>
      <div class="toolbar" aria-label="Засоби форматування">
        <select id="blockFormat" title="Формат блоку">
          <option value="p">Абзац</option><option value="h1">H1</option><option value="h2">H2</option>
          <option value="h3">H3</option><option value="blockquote">Цитата</option><option value="pre">Pre</option>
        </select>
        <select id="fontSize" title="Розмір">
          <option value="">Розмір</option><option value="2">Малий</option><option value="3">Звичайний</option>
          <option value="4">Середній</option><option value="5">Великий</option>
        </select>
        <button type="button" data-cmd="bold"><b>B</b></button>
        <button type="button" data-cmd="italic"><i>I</i></button>
        <button type="button" data-cmd="underline"><u>U</u></button>
        <button type="button" data-cmd="strikeThrough" title="Закреслений">S</button>
        <button type="button" data-cmd="justifyLeft">⟸</button>
        <button type="button" data-cmd="justifyCenter">≡</button>
        <button type="button" data-cmd="justifyRight">⟹</button>
        <button type="button" data-cmd="justifyFull">↔</button>
        <button type="button" data-cmd="insertUnorderedList">• Список</button>
        <button type="button" data-cmd="insertOrderedList">1. Список</button>
        <button type="button" id="mkLink">Посилання</button>
        <button type="button" id="rmLink">Прибрати посилання</button>
        <button type="button" id="insImg">Зображення</button>
        <button type="button" id="clearFmt">Очистити</button>
      </div>
      <div id="editor" contenteditable="true"></div>
    </section>

    <!-- ПРАВА ПАНЕЛЬ: HTML -->
    <section class="panel" aria-label="HTML-код">
      <h2>HTML-код</h2>
      <textarea id="code" spellcheck="false" placeholder="Тут з’явиться HTML…"></textarea>
      <div class="foot-btns">
        <button class="btn" id="btnClean">Очистити</button>
        <button class="btn secondary" id="btnUndo" disabled>Назад</button>
        <button class="btn secondary" id="fontPlus" title="Збільшити шрифт">A+</button>
        <button class="btn secondary" id="fontMinus" title="Зменшити шрифт">A−</button>
        <button class="btn" id="btnCopy">Копіювати</button>
      </div>
    </section>

    <!-- НИЖНІ КАРТКИ -->
    <section class="lower">
      <div class="card">
        <h3>Опції очищення</h3>
        <div class="options" id="options">
          <label><input type="checkbox" id="opt-remove-inline"> Видалити inline-стилі</label>
          <label><input type="checkbox" id="opt-remove-class-id"> Прибрати класи та ID</label>
          <label><input type="checkbox" id="opt-remove-empty"> Видалити порожні теги</label>
          <label><input type="checkbox" id="opt-remove-one-nbsp"> Видалити теги, що містять лише &amp;nbsp;</label>
          <label><input type="checkbox" id="opt-remove-span"> Видалити тег &lt;span&gt;</label>
          <label><input type="checkbox" id="opt-remove-images"> Видалити зображення</label>
          <label><input type="checkbox" id="opt-remove-links"> Видалити посилання (залишити текст)</label>
          <label><input type="checkbox" id="opt-remove-tables"> Розгорнути таблиці (залишити вміст)</label>
          <label><input type="checkbox" id="opt-div-to-p"> Замінити &lt;div&gt; на &lt;p&gt; (зберегти вміст)</label>
          <label><input type="checkbox" id="opt-nbsp-to-space"> Замінити &amp;nbsp; на пробіл (стиснути послідовності до 1)</label>
          <label><input type="checkbox" id="opt-strong-to-h2"> Замінити &lt;strong&gt; на &lt;h2&gt;</label>
          <label><input type="checkbox" id="opt-em-to-h3"> Замінити &lt;em&gt;/&lt;i&gt; на &lt;h3&gt;</label>
        </div>
      </div>

      <div class="card wl-wrap wl-disabled" id="wlCard">
        <h3>Залишити Білий список тегів</h3>
        <div class="note">Коли увімкнено — залишимо тільки обрані теги, решту розгорнемо.</div>
        <label style="display:block;margin-bottom:6px;">
          <input type="checkbox" id="wl-enabled"> Увімкнути Білий список
        </label>

        <ul class="wl-list" id="wlList">
          <li><label><input type="checkbox" data-tag="p"     checked> &lt;p&gt; — абзац</label></li>
          <li><label><input type="checkbox" data-tag="h1"   > &lt;h1&gt; — заголовок 1</label></li>
          <li><label><input type="checkbox" data-tag="h2"   > &lt;h2&gt; — заголовок 2</label></li>
          <li><label><input type="checkbox" data-tag="h3"   > &lt;h3&gt; — заголовок 3</label></li>
          <li><label><input type="checkbox" data-tag="strong" checked> &lt;strong&gt; — жирний</label></li>
          <li><label><input type="checkbox" data-tag="em"     checked> &lt;em&gt; — курсив</label></li>
          <li><label><input type="checkbox" data-tag="ul"   > &lt;ul&gt; — маркований список</label></li>
          <li><label><input type="checkbox" data-tag="ol"   > &lt;ol&gt; — нумерований список</label></li>
          <li><label><input type="checkbox" data-tag="li"   > &lt;li&gt; — пункт списку</label></li>
          <li><label><input type="checkbox" data-tag="a"    > &lt;a&gt; — посилання</label></li>
        </ul>
      </div>

      <div class="card" style="grid-column: 1 / -1;">
        <h3>Пошук і заміна у вихідному HTML</h3>
        <span class="sub">Виконується після очищення; поля <b>чутливі до регістру</b>.</span>
        <div id="findBox"></div>
        <button class="btn secondary" id="btnAddRow">+ Додати поле</button>
      </div>
    </section>
  </main>

  <script>
    /* ===== Елементи ===== */
    const editor   = document.getElementById('editor');
    const codeArea = document.getElementById('code');
    const blockFormat = document.getElementById('blockFormat');
    const fontSize = document.getElementById('fontSize');
    const mkLink   = document.getElementById('mkLink');
    const rmLink   = document.getElementById('rmLink');
    const insImg   = document.getElementById('insImg');
    const clearFmt = document.getElementById('clearFmt');
    const fontPlus = document.getElementById('fontPlus');
    const fontMinus= document.getElementById('fontMinus');
    const btnCopy  = document.getElementById('btnCopy');
    const undoBtn  = document.getElementById('btnUndo');

    const wlEnabled = document.getElementById('wl-enabled');
    const wlCard = document.getElementById('wlCard');
    const wlList = document.getElementById('wlList');

    // Тулбар
    document.querySelectorAll('.toolbar [data-cmd]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.execCommand(btn.dataset.cmd, false);
        editor.focus(); syncToCode();
      });
    });

    blockFormat.addEventListener('change', () => {
      document.execCommand('formatBlock', false, blockFormat.value);
      editor.focus(); syncToCode();
    });
    fontSize.addEventListener('change', () => {
      if (!fontSize.value) return;
      document.execCommand('fontSize', false, fontSize.value);
      syncToCode();
    });

    mkLink.addEventListener('click', () => {
      const url = prompt('Посилання (URL):','https://'); if (!url) return;
      document.execCommand('createLink', false, url); syncToCode();
    });
    rmLink.addEventListener('click', () => { document.execCommand('unlink'); syncToCode(); });
    insImg.addEventListener('click', () => {
      const url = prompt('URL зображення:','https://'); if (!url) return;
      document.execCommand('insertImage', false, url); syncToCode();
    });

    clearFmt.addEventListener('click', () => {
      document.execCommand('removeFormat');
      editor.querySelectorAll('span').forEach(s => s.replaceWith(...s.childNodes));
      syncToCode();
    });

    /* ===== Двостороння синхронізація ===== */
    function syncToCode(){ codeArea.value = prettyHtml(editor.innerHTML); }
    function syncFromCode(){
      // парсимо як HTML і підтягуємо у редактор
      const html = codeArea.value;
      try { editor.innerHTML = html; } catch(e){ /* ігноруємо */ }
    }
    editor.addEventListener('input', syncToCode);
    editor.addEventListener('paste', () => setTimeout(syncToCode));
    codeArea.addEventListener('input', () => { syncFromCode(); });

    /* ===== Зміна розміру шрифту коду ===== */
    function updateCodeFont(delta){
      const cs = getComputedStyle(document.documentElement).getPropertyValue('--code-font-size').trim();
      const px = parseInt(cs || '14', 10) + delta;
      document.documentElement.style.setProperty('--code-font-size', Math.max(10, Math.min(28, px)) + 'px');
    }
    fontPlus.addEventListener('click', () => updateCodeFont(+1));
    fontMinus.addEventListener('click', () => updateCodeFont(-1));

    /* ===== Копіювання ===== */
    btnCopy.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(codeArea.value);
        btnCopy.textContent = 'Скопійовано!'; setTimeout(()=>btnCopy.textContent='Копіювати',1200);
      } catch(e){ codeArea.select(); document.execCommand('copy'); }
    });

    /* ===== Пошук/заміна ===== */
    const findBox = document.getElementById('findBox');
    function addFindRow(findVal = '', replVal = ''){
      const row = document.createElement('div');
      row.className = 'find-row';
      row.innerHTML = `<input type="text" placeholder="Що знайти" value="${findVal.replaceAll('"','&quot;')}">`+
                      `<input type="text" placeholder="На що замінити" value="${replVal.replaceAll('"','&quot;')}">`+
                      `<button class="btn secondary" type="button">Видалити</button>`;
      row.lastElementChild.addEventListener('click', () => row.remove());
      findBox.appendChild(row);
    }
    document.getElementById('btnAddRow').addEventListener('click', () => addFindRow());
    addFindRow();

    /* ===== Утиліти DOM ===== */
    function unwrap(el){
      const parent = el.parentNode; if (!parent) return;
      while(el.firstChild) parent.insertBefore(el.firstChild, el);
      parent.removeChild(el);
    }
    function replaceTag(el, tagName){
      const neo = document.createElement(tagName);
      while(el.firstChild) neo.appendChild(el.firstChild);
      el.replaceWith(neo);
      return neo;
    }
    const qAll = (root, sel) => Array.from(root.querySelectorAll(sel));

    /* ===== Прикрашання HTML (відступи/рядки) ===== */
    function prettyHtml(html){
      try{
        html = String(html);
        const tokens = [];
        let i = 0;
        while (i < html.length) {
          const lt = html.indexOf('<', i);
          if (lt < 0) { const tail = html.slice(i); if (tail.trim()) tokens.push(tail); break; }
          const text = html.slice(i, lt);
          if (text.trim()) tokens.push(text);
          const gt = html.indexOf('>', lt + 1);
          if (gt < 0) { tokens.push(html.slice(lt)); break; }
          tokens.push(html.slice(lt, gt + 1));
          i = gt + 1;
        }
        const voidSet = new Set(['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr']);
        const blockSet = new Set(['html','head','body','div','p','h1','h2','h3','h4','h5','h6','ul','ol','li','table','thead','tbody','tfoot','tr','td','th','section','article','header','footer','nav','blockquote','pre','figure','figcaption','hr']);
        const isTag = (t) => t.startsWith('<') && t.endsWith('>');
        const tagName = (tag) => { let j = tag[1] === '/' ? 2 : 1; let name=''; while (j < tag.length){ const ch = tag[j]; if (ch === ' ' || ch === '>' || ch === '/') break; name += ch; j++; } return name.toLowerCase(); };
        const isCloseTag = (tag) => tag[1] === '/';
        const isSelfClosing = (tag) => tag[tag.length-2] === '/';
        let indent = 0; const out = [];
        for (const t of tokens){
          if (isTag(t)){
            const name = tagName(t);
            const close = isCloseTag(t);
            const selfc = isSelfClosing(t) || voidSet.has(name);
            const isBlock = blockSet.has(name);
            if (close && isBlock) indent = Math.max(0, indent-1);
            out.push('  '.repeat(indent) + t);
            if (!close && isBlock && !selfc) indent++;
          } else {
            const text = t.trim();
            if (text) out.push('  '.repeat(indent) + text);
          }
        }
        return out.join('\n').trim();
      } catch(e){ return String(html); }
    }

    /* ===== Білий список — увімк/вимк та стан чекбоксів ===== */
    function refreshWhitelistState(){
      const on = wlEnabled.checked;
      wlCard.classList.toggle('wl-disabled', !on);
      wlList.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.disabled = !on);
    }
    wlEnabled.addEventListener('change', refreshWhitelistState);
    refreshWhitelistState();

    /* ===== Пайплайн очищення ===== */
    const undoStack = [];
    function pushUndo(){ undoStack.push(codeArea.value); undoBtn.disabled = undoStack.length === 0; }
    undoBtn.addEventListener('click', () => {
      if (!undoStack.length) return;
      codeArea.value = undoStack.pop();
      if (!undoStack.length) undoBtn.disabled = true;
      syncFromCode();
    });

    document.getElementById('btnClean').addEventListener('click', () => {
      pushUndo();
      let html = codeArea.value || editor.innerHTML || '';

      // Парсимо у DOM
      const parser = new DOMParser();
      const doc = parser.parseFromString(`<div id="__root">${html}</div>`, 'text/html');
      const root = doc.getElementById('__root');

      // Зчитування опцій
      const opts = {
        removeInline:   document.getElementById('opt-remove-inline').checked,
        removeClassId:  document.getElementById('opt-remove-class-id').checked,
        removeEmpty:    document.getElementById('opt-remove-empty').checked,
        removeOneNbsp:  document.getElementById('opt-remove-one-nbsp').checked,
        removeSpan:     document.getElementById('opt-remove-span').checked,
        removeImages:   document.getElementById('opt-remove-images').checked,
        removeLinks:    document.getElementById('opt-remove-links').checked,
        removeTables:   document.getElementById('opt-remove-tables').checked,
        divToP:         document.getElementById('opt-div-to-p').checked,
        nbspToSpace:    document.getElementById('opt-nbsp-to-space').checked,
        strongToH2:     document.getElementById('opt-strong-to-h2').checked,
        emToH3:         document.getElementById('opt-em-to-h3').checked,
        wlEnabled:      wlEnabled.checked
      };

      // Попередні дії
      if (opts.removeImages) qAll(root, 'img').forEach(el => el.remove());
      if (opts.removeLinks)  qAll(root, 'a').forEach(el => unwrap(el));
      if (opts.removeSpan)   qAll(root, 'span').forEach(el => unwrap(el));
      if (opts.divToP)       qAll(root, 'div').forEach(el => replaceTag(el, 'p'));
      if (opts.strongToH2)   qAll(root, 'strong').forEach(el => replaceTag(el, 'h2'));
      if (opts.emToH3)       qAll(root, 'em, i').forEach(el => replaceTag(el, 'h3'));

      if (opts.removeTables) qAll(root, 'table, thead, tbody, tfoot, tr, td, th').forEach(el => unwrap(el));

      if (opts.removeInline) qAll(root, '[style]').forEach(el => el.removeAttribute('style'));
      if (opts.removeClassId){ qAll(root, '[class]').forEach(el => el.removeAttribute('class')); qAll(root, '[id]').forEach(el => el.removeAttribute('id')); }

      // Білий список
      if (opts.wlEnabled){
        const allowed = new Set(
          Array.from(wlList.querySelectorAll('input[data-tag]:checked')).map(i => i.dataset.tag)
        );
        // Захисна умова: якщо нічого не вибрано — не руйнуємо, вважаємо, що принаймні <p> дозволено
        if (allowed.size === 0) allowed.add('p');

        qAll(root, '*').forEach(el => {
          const tag = el.tagName.toLowerCase();
          if (!allowed.has(tag)){
            // Не дозволено — розгортаємо
            unwrap(el);
          }
        });
      }

      // Порожні / тільки &nbsp; теги — рекурсивне прибирання
      if (opts.removeEmpty || opts.removeOneNbsp){
        const onlyNbsp = /^(\s|\u00A0|&nbsp;)*$/;
        let changed;
        do {
          changed = false;
          qAll(root, '*').forEach(el => {
            const noKids = !el.firstElementChild;
            const txt = (el.textContent || '').replace(/\s+/g,' ').trim();
            if (opts.removeOneNbsp && noKids && onlyNbsp.test(el.innerHTML || '')) { el.remove(); changed = true; return; }
            if (opts.removeEmpty && noKids && txt === '') { el.remove(); changed = true; }
          });
        } while (changed);
      }

      // Серіалізуємо й текстові заміни
      html = root.innerHTML;

      if (opts.nbspToSpace){
        // 1) &nbsp; → пробіл
        html = html.replace(/&nbsp;|\u00A0/g, ' ');
        // 2) Стискаємо послідовності пробілів до 1
        html = html.replace(/ {2,}/g, ' ');
      }

      // Пошук/заміну застосовуємо в кінці
      const rows = Array.from(findBox.querySelectorAll('.find-row'));
      for (const row of rows) {
        const [findInput, replInput] = row.querySelectorAll('input');
        const find = findInput.value; if (!find) continue; const repl = replInput.value;
        const esc = find.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        html = html.replace(new RegExp(esc, 'g'), repl);
      }

      codeArea.value = prettyHtml(html);
      syncFromCode(); // щоб ліворуч відобразилися зміни
    });

    // Стартовий хінт
    editor.innerHTML = '<p><strong>Ласкаво просимо!</strong> Вставте текст ліворуч. Праворуч з’явиться HTML-код. Оберіть опції очищення і натисніть <em>Очистити</em>.</p>';
    syncToCode();
  </script>
</body>
</html>
