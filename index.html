<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—á–∏—â—É–≤–∞—á HTML (MVP) ‚Äî –≤–µ—Ä—Å—ñ—è 12</title>

  <style>
    /* =========================
       –¢–µ–º–∞: –Ω—ñ—á–Ω–∞ / –¥–µ–Ω–Ω–∞
       ========================= */
    :root{
      --bg: #0b1020;
      --bg-2:#0f1630;
      --bg-3:#121a3a;
      --txt:#e7ecf7;
      --muted:#9fb0e3;
      --line:#1b2445;
      --chip:#16224a;
      --chip-2:#2a3a78;
      --btn:#2952ff;
      --btn-2:#4669ff;
      --code-bg:#0a112b;
      --code-txt:#d7e1ff;
      --radius:10px;
      --gap:14px;
      --code-font-size:14px;
    }
    body.light{
      --bg:#f7f8fb;
      --bg-2:#ffffff;
      --bg-3:#f1f3f9;
      --txt:#111827;
      --muted:#4b5563;
      --line:#e5e7eb;
      --chip:#f4f6fb;
      --chip-2:#cbd5e1;
      --btn:#2563eb;
      --btn-2:#3b82f6;
      --code-bg:#0b122b0d;
      --code-txt:#0f172a;
    }

    /* –ë–∞–∑–æ–≤–∞ —Å—ñ—Ç–∫–∞/—Ç–∏–ø–æ–≥—Ä–∞—Ñ—ñ–∫–∞ */
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{padding:12px 16px;border-bottom:1px solid var(--line);background:var(--bg-2);position:sticky;top:0;z-index:5;display:flex;align-items:center;gap:12px;justify-content:space-between}
    header h1{margin:0;font-size:18px;font-weight:700}
    .theme-btn{background:var(--chip);border:1px solid var(--chip-2);color:var(--txt);padding:8px 12px;border-radius:999px;cursor:pointer}

    .wrap{padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    .panel{background:var(--bg-2);border:1px solid var(--line);border-radius:var(--radius);display:flex;flex-direction:column;min-height:380px;overflow:hidden}
    .panel h2{margin:0;padding:10px 12px;font-size:14px;border-bottom:1px solid var(--line);background:var(--bg-3)}
    .toolbar{display:flex;flex-wrap:wrap;gap:6px;padding:10px;border-bottom:1px solid var(--line);background:var(--bg-2)}
    .toolbar button,.toolbar select{background:var(--chip);color:var(--txt);border:1px solid var(--chip-2);border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}
    .toolbar button:hover,.toolbar select:hover{background:var(--chip-2);color:#fff}

    #editor{padding:12px;height:520px;outline:none;line-height:1.5;overflow:auto;resize:vertical}
    #editor:empty:before{content:'–í—Å—Ç–∞–≤—Ç–µ –∞–±–æ –Ω–∞–ø–∏—à—ñ—Ç—å —Ç–µ–∫—Å—Ç —Ç—É—Ç‚Ä¶';color:var(--muted)}
    #code{width:100%;padding:12px;height:520px;background:var(--code-bg);color:var(--code-txt);border:0;resize:vertical;outline:none;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:var(--code-font-size);line-height:1.5}

    .foot-btns{display:flex;gap:8px;padding:10px;border-top:1px solid var(--line);background:var(--bg-2)}
    .btn{background:var(--btn);border:1px solid var(--btn-2);color:#fff;padding:9px 12px;border-radius:10px;font-size:14px;cursor:pointer}
    .btn.secondary{background:var(--chip);border-color:var(--chip-2);color:var(--txt)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .lower{grid-column:1 / -1;display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    .card{background:var(--bg-2);border:1px solid var(--line);border-radius:var(--radius);padding:12px}
    .card h3{margin:4px 0 10px;font-size:14px;font-weight:700}
    .sub{display:block;margin-top:-6px;margin-bottom:8px;opacity:.8;font-size:12px;color:var(--muted)}

    .options{columns:2;column-gap:22px}
    .options label{display:block;break-inside:avoid;margin:6px 0;font-size:13px;cursor:pointer;white-space:normal;word-break:break-word}
    .options input{margin-right:6px}

    .find-row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin:8px 0}
    .find-row input{background:var(--code-bg);color:var(--txt);border:1px solid var(--chip-2);border-radius:8px;padding:8px 10px;font-size:13px}
    .whitelist{margin:8px 0 2px 18px;display:grid;grid-template-columns:repeat(2, minmax(160px,1fr));gap:6px}
    .whitelist.disabled{opacity:.5;pointer-events:none}
    details.whbox summary{cursor:pointer;user-select:none}
    details.whbox{margin:6px 0}

    @media (max-width:1100px){.wrap{grid-template-columns:1fr}.lower{grid-template-columns:1fr}.whitelist{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>–û—á–∏—â—É–≤–∞—á HTML (MVP) ‚Äî –≤–µ—Ä—Å—ñ—è 12</h1>
    <button id="themeBtn" class="theme-btn">üåô –ù—ñ—á–Ω–∞ —Ç–µ–º–∞</button>
  </header>

  <main class="wrap">
    <!-- –õ—ñ–≤–∞ –ø–∞–Ω–µ–ª—å: WYSIWYG-—Ä–µ–¥–∞–∫—Ç–æ—Ä -->
    <section class="panel" aria-label="–¢–µ–∫—Å—Ç">
      <h2>–¢–µ–∫—Å—Ç</h2>
      <div class="toolbar" aria-label="–ó–∞—Å–æ–±–∏ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è">
        <select id="blockFormat" title="–§–æ—Ä–º–∞—Ç –±–ª–æ–∫—É">
          <option value="p">–ê–±–∑–∞—Ü</option>
          <option value="h1">H1</option>
          <option value="h2">H2</option>
          <option value="h3">H3</option>
          <option value="blockquote">–¶–∏—Ç–∞—Ç–∞</option>
          <option value="pre">Pre</option>
        </select>
        <select id="fontSize" title="–†–æ–∑–º—ñ—Ä —à—Ä–∏—Ñ—Ç—É">
          <option value="">–†–æ–∑–º—ñ—Ä</option>
          <option value="2">–ú–∞–ª–∏–π</option>
          <option value="3">–ó–≤–∏—á–∞–π–Ω–∏–π</option>
          <option value="4">–°–µ—Ä–µ–¥–Ω—ñ–π</option>
          <option value="5">–í–µ–ª–∏–∫–∏–π</option>
        </select>
        <button type="button" data-cmd="bold"><b>B</b></button>
        <button type="button" data-cmd="italic"><i>I</i></button>
        <button type="button" data-cmd="underline"><u>U</u></button>
        <button type="button" data-cmd="strikeThrough" title="–ó–∞–∫—Ä–µ—Å–ª–µ–Ω–∏–π">S</button>
        <button type="button" data-cmd="justifyLeft" title="–í–∏—Ä—ñ–≤–Ω—è—Ç–∏ –ª—ñ–≤–æ—Ä—É—á">‚ü∏</button>
        <button type="button" data-cmd="justifyCenter" title="–ü–æ —Ü–µ–Ω—Ç—Ä—É">‚â°</button>
        <button type="button" data-cmd="justifyRight" title="–í–∏—Ä—ñ–≤–Ω—è—Ç–∏ –ø—Ä–∞–≤–æ—Ä—É—á">‚üπ</button>
        <button type="button" data-cmd="justifyFull" title="–ü–æ —à–∏—Ä–∏–Ω—ñ">‚Üî</button>
        <button type="button" data-cmd="insertUnorderedList">‚Ä¢ –°–ø–∏—Å–æ–∫</button>
        <button type="button" data-cmd="insertOrderedList">1. –°–ø–∏—Å–æ–∫</button>
        <button type="button" data-cmd="outdent" title="–ó–º–µ–Ω—à–∏—Ç–∏ –≤—ñ–¥—Å—Ç—É–ø">‚óÅ</button>
        <button type="button" data-cmd="indent" title="–ó–±—ñ–ª—å—à–∏—Ç–∏ –≤—ñ–¥—Å—Ç—É–ø">‚ñ∑</button>
        <button type="button" id="mkLink">–ü–æ—Å–∏–ª–∞–Ω–Ω—è</button>
        <button type="button" id="rmLink">–ü—Ä–∏–±—Ä–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</button>
        <button type="button" id="insImg" title="–í—Å—Ç–∞–≤–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è</button>
        <button type="button" id="clearFmt" title="–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è">–û—á–∏—Å—Ç–∏—Ç–∏</button>
      </div>
      <div id="editor" contenteditable="true"></div>
    </section>

    <!-- –ü—Ä–∞–≤–∞ –ø–∞–Ω–µ–ª—å: HTML-–∫–æ–¥ -->
    <section class="panel" aria-label="HTML-–∫–æ–¥">
      <h2>HTML-–∫–æ–¥</h2>
      <textarea id="code" spellcheck="false" placeholder="–¢—É—Ç –∑‚Äô—è–≤–∏—Ç—å—Å—è HTML‚Ä¶"></textarea>
      <div class="foot-btns">
        <button class="btn" id="btnClean">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        <button class="btn secondary" id="btnUndo" disabled>–ù–∞–∑–∞–¥</button>
        <button class="btn secondary" id="fontPlus" title="–ó–±—ñ–ª—å—à–∏—Ç–∏ —à—Ä–∏—Ñ—Ç">A+</button>
        <button class="btn secondary" id="fontMinus" title="–ó–º–µ–Ω—à–∏—Ç–∏ —à—Ä–∏—Ñ—Ç">A‚àí</button>
        <button class="btn" id="btnCopy">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
      </div>
    </section>

    <!-- –ù–∏–∂–Ω—ñ–π –±–ª–æ–∫: –û–ø—Ü—ñ—ó + –ü–æ—à—É–∫/–∑–∞–º—ñ–Ω–∞ -->
    <section class="lower">
      <div class="card">
        <h3>–û–ø—Ü—ñ—ó –æ—á–∏—â–µ–Ω–Ω—è</h3>
        <div class="options" id="options">
          <label><input type="checkbox" id="opt-remove-inline"> –í–∏–¥–∞–ª–∏—Ç–∏ inline-—Å—Ç–∏–ª—ñ</label>
          <label><input type="checkbox" id="opt-remove-class-id"> –ü—Ä–∏–±—Ä–∞—Ç–∏ –∫–ª–∞—Å–∏ —Ç–∞ ID</label>
          <label><input type="checkbox" id="opt-remove-empty"> –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ —Ç–µ–≥–∏</label>
          <label><input type="checkbox" id="opt-remove-only-nbsp"> –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–≥–∏, —â–æ –º—ñ—Å—Ç—è—Ç—å –ª–∏—à–µ &amp;nbsp;</label>
          <label><input type="checkbox" id="opt-remove-span"> –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–≥ &lt;span&gt;</label>
          <label><input type="checkbox" id="opt-remove-images"> –í–∏–¥–∞–ª–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>

          <label><input type="checkbox" id="opt-div-to-p"> –ü—ñ–¥ —á–∞—Å ¬´–û—á–∏—Å—Ç–∏—Ç–∏¬ª –∑–∞–º—ñ–Ω–∏—Ç–∏ &lt;div&gt; –Ω–∞ &lt;p&gt;</label>
          <label><input type="checkbox" id="opt-remove-p-in-tables"> –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–≥–∏ &lt;p&gt; —É —Ç–∞–±–ª–∏—Ü—è—Ö</label>

          <!-- –ë—ñ–ª–∏–π —Å–ø–∏—Å–æ–∫ (—Ä–æ–∑–∫—Ä–∏–≤–Ω–∏–π) -->
          <details class="whbox">
            <summary><label style="cursor:pointer"><input type="checkbox" id="opt-whitelist"> –ó–∞–ª–∏—à–∏—Ç–∏ –ë—ñ–ª–∏–π —Å–ø–∏—Å–æ–∫ —Ç–µ–≥—ñ–≤ (–æ–±–µ—Ä—ñ—Ç—å –Ω–∏–∂—á–µ)</label></summary>
            <div id="whitelistBox" class="whitelist disabled">
              <label><input type="checkbox" data-tag="p" checked> &lt;p&gt; ‚Äî –∞–±–∑–∞—Ü</label>
              <label><input type="checkbox" data-tag="h1"> &lt;h1&gt; ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫ 1</label>
              <label><input type="checkbox" data-tag="h2" checked> &lt;h2&gt; ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫ 2</label>
              <label><input type="checkbox" data-tag="h3" checked> &lt;h3&gt; ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫ 3</label>
              <label><input type="checkbox" data-tag="strong" checked> &lt;strong&gt; ‚Äî –∂–∏—Ä–Ω–∏–π</label>
              <label><input type="checkbox" data-tag="em" checked> &lt;em&gt; ‚Äî –∫—É—Ä—Å–∏–≤</label>
              <label><input type="checkbox" data-tag="ul" checked> &lt;ul&gt; ‚Äî –º–∞—Ä–∫–æ–≤–∞–Ω–∏–π —Å–ø–∏—Å–æ–∫</label>
              <label><input type="checkbox" data-tag="ol" checked> &lt;ol&gt; ‚Äî –Ω—É–º–µ—Ä–æ–≤–∞–Ω–∏–π —Å–ø–∏—Å–æ–∫</label>
              <label><input type="checkbox" data-tag="li" checked> &lt;li&gt; ‚Äî –ø—É–Ω–∫—Ç</label>
              <label><input type="checkbox" data-tag="a" checked> &lt;a&gt; ‚Äî –ø–æ—Å–∏–ª–∞–Ω–Ω—è</label>
            </div>
          </details>

          <label><input type="checkbox" id="opt-nbsp-to-space"> –ó–∞–º—ñ–Ω–∏—Ç–∏ &amp;nbsp; –Ω–∞ –ø—Ä–æ–±—ñ–ª (—Å—Ç–∏—Å–Ω—É—Ç–∏ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ –¥–æ 1)</label>
          <label><input type="checkbox" id="opt-strong-to-h2"> –ó–∞–º—ñ–Ω–∏—Ç–∏ &lt;strong&gt; –Ω–∞ &lt;h2&gt;</label>
          <label><input type="checkbox" id="opt-em-to-h3"> –ó–∞–º—ñ–Ω–∏—Ç–∏ &lt;em&gt;/&lt;i&gt; –Ω–∞ &lt;h3&gt;</label>
        </div>
      </div>

      <div class="card">
        <h3>–ü–æ—à—É–∫ —ñ –∑–∞–º—ñ–Ω–∞ —É –≤–∏—Ö—ñ–¥–Ω–æ–º—É HTML</h3>
        <span class="sub">–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø—ñ—Å–ª—è –æ—á–∏—â–µ–Ω–Ω—è; –ø–æ–ª—è <b>—á—É—Ç–ª–∏–≤—ñ –¥–æ —Ä–µ–≥—ñ—Å—Ç—Ä—É</b>.</span>
        <div id="findBox"></div>
        <button class="btn secondary" id="btnAddRow">+ –î–æ–¥–∞—Ç–∏ –ø–æ–ª–µ</button>
      </div>
    </section>
  </main>

  <script>
    /* =========================
       –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç–∏
       ========================= */
    const editor   = document.getElementById('editor');
    const codeArea = document.getElementById('code');
    const undoBtn  = document.getElementById('btnUndo');
    const blockFormat = document.getElementById('blockFormat');
    const fontSize    = document.getElementById('fontSize');
    const mkLink   = document.getElementById('mkLink');
    const rmLink   = document.getElementById('rmLink');
    const insImg   = document.getElementById('insImg');
    const clearFmt = document.getElementById('clearFmt');
    const fontPlus = document.getElementById('fontPlus');
    const fontMinus= document.getElementById('fontMinus');
    const btnCopy  = document.getElementById('btnCopy');
    const themeBtn = document.getElementById('themeBtn');

    /* =========================
       –ü–µ—Ä–µ–º–∏–∫–∞—á —Ç–µ–º–∏
       ========================= */
    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('light');
      themeBtn.textContent = document.body.classList.contains('light') ? 'üåô –ù—ñ—á–Ω–∞ —Ç–µ–º–∞' : '‚òÄÔ∏è –î–µ–Ω–Ω–∞ —Ç–µ–º–∞';
    });

    /* =========================
       –¢—É–ª–±–∞—Ä —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
       ========================= */
    document.querySelectorAll('.toolbar [data-cmd]').forEach(btn=>{
      btn.addEventListener('click',()=>{ document.execCommand(btn.dataset.cmd,false); editor.focus(); syncFromEditor(); });
    });
    blockFormat.addEventListener('change',()=>{ document.execCommand('formatBlock',false,blockFormat.value); syncFromEditor(); });
    fontSize.addEventListener('change',()=>{ if(!fontSize.value) return; document.execCommand('fontSize',false,fontSize.value); syncFromEditor(); });

    mkLink.addEventListener('click',()=>{ const url=prompt('–ü–æ—Å–∏–ª–∞–Ω–Ω—è (URL):','https://'); if(!url) return; document.execCommand('createLink',false,url); syncFromEditor(); });
    rmLink.addEventListener('click',()=>{ document.execCommand('unlink'); syncFromEditor(); });
    insImg.addEventListener('click',()=>{ const url=prompt('URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:','https://'); if(!url) return; document.execCommand('insertImage',false,url); syncFromEditor(); });

    // –û—á–∏—Å—Ç–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è —É –≤–∏–¥—ñ–ª–µ–Ω–Ω—ñ + —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è span
    clearFmt.addEventListener('click',()=>{
      document.execCommand('removeFormat');
      editor.querySelectorAll('span').forEach(s=>s.replaceWith(...s.childNodes));
      syncFromEditor();
    });

    /* =========================
       –ñ–∏–≤–∏–π –æ–±–º—ñ–Ω: –∑–ª—ñ–≤–∞ ‚Üî —Å–ø—Ä–∞–≤–∞
       ========================= */
    const undoStack = [];
    function pushUndo(){ undoStack.push(codeArea.value); undoBtn.disabled=false; }
    undoBtn.addEventListener('click',()=>{ if(!undoStack.length) return; codeArea.value=undoStack.pop(); if(!undoStack.length) undoBtn.disabled=true; syncToEditor(); });

    // –ó–ª—ñ–≤–∞ ‚Üí –ü—Ä–∞–≤–æ—Ä—É—á
    function syncFromEditor(){ codeArea.value = prettyHtml(editor.innerHTML); }
    editor.addEventListener('input', syncFromEditor);
    editor.addEventListener('paste', ()=> setTimeout(syncFromEditor));

    // –ü—Ä–∞–≤–æ—Ä—É—á ‚Üí –ó–ª—ñ–≤–∞ (–∑ –Ω–µ–≤–µ–ª–∏—á–∫–æ—é –∑–∞—Ç—Ä–∏–º–∫–æ—é, —â–æ–±–∏ –Ω–µ ¬´—Å—Ç—Ä–∏–±–∞–ª–æ¬ª –ø—ñ–¥ —á–∞—Å –Ω–∞–±–æ—Ä—É)
    let syncTimer=null;
    function syncToEditor(){ clearTimeout(syncTimer); syncTimer=setTimeout(()=>{ editor.innerHTML = sanitizeHtml(codeArea.value); }, 150); }
    codeArea.addEventListener('input', syncToEditor);

    // –ó–º—ñ–Ω–∞ —Ä–æ–∑–º—ñ—Ä—É —à—Ä–∏—Ñ—Ç—É —É –∫–æ–¥—ñ
    function updateCodeFont(delta){ const cur=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--code-font-size')||'14',10); document.documentElement.style.setProperty('--code-font-size', Math.max(10,Math.min(28,cur+delta))+'px'); }
    fontPlus.addEventListener('click',()=>updateCodeFont(+1));
    fontMinus.addEventListener('click',()=>updateCodeFont(-1));

    // –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –∫–æ–¥—É
    btnCopy.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(codeArea.value); btnCopy.textContent='–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!'; setTimeout(()=>btnCopy.textContent='–ö–æ–ø—ñ—é–≤–∞—Ç–∏',1200); }
      catch{ codeArea.select(); document.execCommand('copy'); }
    });

    /* =========================
       –ü–æ—à—É–∫/–ó–∞–º—ñ–Ω–∞ (UI)
       ========================= */
    const findBox=document.getElementById('findBox');
    function addFindRow(findVal='',replVal=''){
      const row=document.createElement('div');
      row.className='find-row';
      row.innerHTML=`<input type="text" placeholder="–©–æ –∑–Ω–∞–π—Ç–∏" value="${findVal.replaceAll('"','&quot;')}">
                     <input type="text" placeholder="–ù–∞ —â–æ –∑–∞–º—ñ–Ω–∏—Ç–∏" value="${replVal.replaceAll('"','&quot;')}">
                     <button class="btn secondary" type="button">–í–∏–¥–∞–ª–∏—Ç–∏</button>`;
      row.lastElementChild.addEventListener('click',()=>row.remove());
      findBox.appendChild(row);
    }
    document.getElementById('btnAddRow').addEventListener('click',()=>addFindRow());
    addFindRow();

    /* =========================
       –£—Ç–∏–ª—ñ—Ç–∏ DOM
       ========================= */
    const VOID = new Set(['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr']);
    const BLOCK = new Set(['html','head','body','div','p','h1','h2','h3','h4','h5','h6','ul','ol','li','table','thead','tbody','tfoot','tr','td','th','section','article','header','footer','nav','blockquote','pre','figure','figcaption','hr']);
    function unwrap(el){ const p=el.parentNode; if(!p) return; while(el.firstChild) p.insertBefore(el.firstChild, el); p.removeChild(el); }
    function replaceTag(el,name){ const neo=document.createElement(name); while(el.firstChild) neo.appendChild(el.firstChild); el.replaceWith(neo); return neo; }
    function qAll(root,sel){ return Array.from(root.querySelectorAll(sel)); }

    /* =========================
       –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è HTML-—Ç–µ–∫—Å—Ç—É
       ========================= */
    function prettyHtml(html){
      try{
        html=String(html);
        const out=[]; let i=0;
        while(i<html.length){
          const lt=html.indexOf('<',i);
          if(lt<0){ const tail=html.slice(i); if(tail.trim()) out.push(tail); break; }
          const text=html.slice(i,lt);
          if(text.trim()) out.push(text);
          const gt=html.indexOf('>',lt+1); if(gt<0){ out.push(html.slice(lt)); break; }
          out.push(html.slice(lt,gt+1)); i=gt+1;
        }
        let indent=0;
        for(const t of out){
          if(t[0]==='<'){
            const close = t[1]==='/';
            // —ñ–º'—è —Ç–µ–≥–∞
            let j = close?2:1, name=''; while(j<t.length && /[^\s>/]/.test(t[j])) name+=t[j++];
            const isBlock = BLOCK.has(name.toLowerCase());
            const selfc = VOID.has(name.toLowerCase()) || t[t.length-2]==='/';
            if(close && isBlock) indent=Math.max(0,indent-1);
            out[out.indexOf(t)] = '  '.repeat(indent)+t;
            if(!close && isBlock && !selfc) indent++;
          }else{
            out[out.indexOf(t)] = '  '.repeat(indent)+t.trim();
          }
        }
        return out.join('\n').trim();
      }catch{ return String(html); }
    }

    // –°–∞–Ω—ñ—Ç–∏–∑–∞—Ü—ñ—è: DOMParser –≤–∏–ø—Ä–∞–≤–ª—è—î –ø–æ–ª–æ–≤–∏–Ω—É ¬´–±–∏—Ç–æ–≥–æ¬ª HTML, –º–∏ –ª–∏—à–µ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ innerHTML
    function sanitizeHtml(str){
      const doc = new DOMParser().parseFromString(`<div id="__root">${str}</div>`,'text/html');
      return doc.getElementById('__root').innerHTML;
    }

    /* =========================
       –ë—ñ–ª–∏–π —Å–ø–∏—Å–æ–∫: –∫–µ—Ä—É–≤–∞–Ω–Ω—è UI
       ========================= */
    const wlToggle = document.getElementById('opt-whitelist');
    const wlBox    = document.getElementById('whitelistBox');
    function updateWlState(){ wlBox.classList.toggle('disabled', !wlToggle.checked); }
    wlToggle.addEventListener('change', updateWlState);
    updateWlState();

    /* =========================
       –ö–Ω–æ–ø–∫–∞ ¬´–û—á–∏—Å—Ç–∏—Ç–∏¬ª ‚Äî –æ—Å–Ω–æ–≤–Ω–∏–π –ø–∞–π–ø–ª–∞–π–Ω
       ========================= */
    document.getElementById('btnClean').addEventListener('click', ()=>{
      pushUndo();

      // 1) –ë–µ—Ä–µ–º–æ –¥–∂–µ—Ä–µ–ª–æ (–ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç –ø—Ä–∞–≤–æ–≥–æ –ø–æ–ª—è)
      let html = (codeArea.value && codeArea.value.trim()!=='') ? codeArea.value : editor.innerHTML;

      // 2) –ü–∞—Ä—Å–∏–º–æ —É DOM
      const doc  = new DOMParser().parseFromString(`<div id="__root">${html}</div>`, 'text/html');
      const root = doc.getElementById('__root');

      // 3) –ß–∏—Ç–∞—î–º–æ –æ–ø—Ü—ñ—ó
      const opts = {
        removeInline:   document.getElementById('opt-remove-inline').checked,
        removeClassId:  document.getElementById('opt-remove-class-id').checked,
        removeEmpty:    document.getElementById('opt-remove-empty').checked,
        removeOnlyNbsp: document.getElementById('opt-remove-only-nbsp').checked,
        removeSpan:     document.getElementById('opt-remove-span').checked,
        removeImages:   document.getElementById('opt-remove-images').checked,
        divToP:         document.getElementById('opt-div-to-p').checked,
        removePInTables:document.getElementById('opt-remove-p-in-tables').checked,
        nbspToSpace:    document.getElementById('opt-nbsp-to-space').checked,
        strongToH2:     document.getElementById('opt-strong-to-h2').checked,
        emToH3:         document.getElementById('opt-em-to-h3').checked,
        whitelist:      wlToggle.checked,
        whitelistTags:  Array.from(wlBox.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.dataset.tag)
      };

      /* ===== –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ñ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø–æ DOM ===== */

      // 3.1 –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è/–ø–æ—Å–∏–ª–∞–Ω–Ω—è/—Å—Ç–∏–ª—ñ/–∫–ª–∞—Å–∏
      if(opts.removeImages) qAll(root,'img').forEach(el=>el.remove());
      if(opts.removeInline) qAll(root,'[style]').forEach(el=>el.removeAttribute('style'));
      if(opts.removeClassId){ qAll(root,'[class]').forEach(el=>el.removeAttribute('class')); qAll(root,'[id]').forEach(el=>{ if(el!==root) el.removeAttribute('id'); }); }

      // 3.2 –í–∏–¥–∞–ª–∏—Ç–∏ <span> (—Ä–æ–∑–≥–æ—Ä—Ç–∞—î–º–æ –≤–º—ñ—Å—Ç)
      if(opts.removeSpan) qAll(root,'span').forEach(unwrap);

      // 3.3 –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–∞–º—ñ–Ω–∞ <div> ‚Üí <p>
      if(opts.divToP) qAll(root,'div').forEach(el=>replaceTag(el,'p'));

      // 3.4 –í–∏–¥–∞–ª–∏—Ç–∏ <p> –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ç–∞–±–ª–∏—Ü—å (—Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏)
      if(opts.removePInTables) qAll(root,'table p, thead p, tbody p, tr p, td p, th p').forEach(unwrap);

      // 3.5 –ú–∞–ø—ñ–Ω–≥–∏ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
      if(opts.strongToH2) qAll(root,'strong').forEach(el=>replaceTag(el,'h2'));
      if(opts.emToH3)     qAll(root,'em, i').forEach(el=>replaceTag(el,'h3'));

      // 3.6 –ë—ñ–ª–∏–π —Å–ø–∏—Å–æ–∫ ‚Äî —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –≤—Å–µ, —â–æ –Ω–µ –≤—Ö–æ–¥–∏—Ç—å –¥–æ –ø–µ—Ä–µ–ª—ñ–∫—É
      if(opts.whitelist){
        const keep = new Set(opts.whitelistTags.map(t=>t.toLowerCase()));
        qAll(root,'*').forEach(el=>{
          const name = el.tagName.toLowerCase();
          if(el===root) return;
          if(!keep.has(name)) unwrap(el);
        });
      }

      // 3.7 –ü—Ä–∏–±—Ä–∞—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ / –µ–ª–µ–º–µ–Ω—Ç–∏ –∑ –æ–¥–Ω–∏–º NBSP
      if(opts.removeEmpty || opts.removeOnlyNbsp){
        let changed; const onlyNbsp = /^(\s|&nbsp;|\u00A0)*$/;
        do{
          changed=false;
          qAll(root,'*').forEach(el=>{
            if(el===root) return;
            const noChildren = !el.firstElementChild;
            const text = el.innerHTML || '';
            if(opts.removeOnlyNbsp && noChildren && onlyNbsp.test(text)) { el.remove(); changed=true; return; }
            if(opts.removeEmpty && noChildren && text.trim()==='')       { el.remove(); changed=true; }
          });
        }while(changed);
      }

      // 3.8 –†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ <span> –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤/strong/em (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ —Ä—É—á–Ω–æ—ó –ø—Ä–∞–≤–∫–∏ –ø—Ä–∞–≤–æ—Ä—É—á)
      qAll(root,'h1,h2,h3,strong,em').forEach(h=>{
        qAll(h,'span').forEach(unwrap);
      });

      // 3.9 –ì–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏, —â–æ ¬´–≥–æ–ª–∏–π¬ª —Ç–µ–∫—Å—Ç —Å—Ç–∞—î –∞–±–∑–∞—Ü–µ–º <p>
      (function ensureParagraphs(){
        // –¢–µ–∫—Å—Ç–æ–≤—ñ –≤—É–∑–ª–∏ –Ω–∞ –≤–µ—Ä—Ö–Ω—å–æ–º—É —Ä—ñ–≤–Ω—ñ
        Array.from(root.childNodes).forEach(n=>{
          if(n.nodeType===3 && n.nodeValue.trim()!==''){
            const p=doc.createElement('p'); p.textContent=n.nodeValue; n.replaceWith(p);
          }
        });
        // –Ü–Ω–ª–∞–π–Ω–æ–≤—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –Ω–∞ –≤–µ—Ä—Ö–Ω—å–æ–º—É —Ä—ñ–≤–Ω—ñ ‚Üí –∑–∞–≥–æ—Ä—Ç–∞—î–º–æ –≤ <p>
        Array.from(root.children).forEach(el=>{
          const name=el.tagName.toLowerCase();
          if(!BLOCK.has(name)) { const p=doc.createElement('p'); el.replaceWith(p); p.appendChild(el); }
        });
        // –í–∫–ª–∞–¥–µ–Ω—ñ <p> ‚Üí —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏
        qAll(root,'p p').forEach(unwrap);
        // –ü–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ –ø–æ—Ä–æ–∂–Ω—ñ <p> ‚Üí –æ–¥–∏–Ω
        const isBlank = (el)=>(!el.textContent || el.textContent.replace(/\u00A0|\s/g,'')==='') && !el.firstElementChild;
        let changed;
        do{
          changed=false;
          const ps=qAll(root,'p');
          for(let i=0;i<ps.length-1;i++){ if(isBlank(ps[i]) && isBlank(ps[i+1])) { ps[i+1].remove(); changed=true; break; } }
        }while(changed);
      })();

      // 4) –°–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ‚Üí —Ä—è–¥–æ–∫
      html = root.innerHTML;

      // 4.1 NBSP ‚Üí –ø—Ä–æ–±—ñ–ª + —Å—Ç–∏—Å–∫–∞–Ω–Ω—è ¬´–±–∞–≥–∞—Ç–æ –ø—Ä–æ–±—ñ–ª—ñ–≤¬ª –¥–æ –æ–¥–Ω–æ–≥–æ
      if(opts.nbspToSpace){
        html = html.replace(/(?:&nbsp;|\u00A0)+/g,' ');
        html = html.replace(/ {2,}/g,' ');
      }

      // 5) –ü–æ—à—É–∫/–∑–∞–º—ñ–Ω–∞ (–±—É–∫–≤–∞–ª—å–Ω–∞, –≥–ª–æ–±–∞–ª—å–Ω–∞)
      Array.from(document.querySelectorAll('.find-row')).forEach(row=>{
        const [f,r] = row.querySelectorAll('input');
        const find=f.value; if(!find) return;
        const repl=r.value;
        const esc=find.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        html = html.replace(new RegExp(esc,'g'),repl);
      });

      // 6) –í–∏–≤—ñ–¥ —ñ –¥–∑–µ—Ä–∫–∞–ª–æ
      codeArea.value = prettyHtml(html);
      editor.innerHTML = html; // –æ–¥—Ä–∞–∑—É –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —ñ –∑–ª—ñ–≤–∞
    });

    /* –°—Ç–∞—Ä—Ç–æ–≤–∏–π –ø—Ä–∏–∫–ª–∞–¥ */
    editor.innerHTML = '<p><strong>–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!</strong> –í—Å—Ç–∞–≤—Ç–µ —Ç–µ–∫—Å—Ç –ª—ñ–≤–æ—Ä—É—á. –ü—Ä–∞–≤–æ—Ä—É—á –∑‚Äô—è–≤–∏—Ç—å—Å—è HTML-–∫–æ–¥. –û–±–µ—Ä—ñ—Ç—å –æ–ø—Ü—ñ—ó –æ—á–∏—â–µ–Ω–Ω—è –π –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å <em>–û—á–∏—Å—Ç–∏—Ç–∏</em>.</p>';
    syncFromEditor();
  </script>
</body>
</html>
