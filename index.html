<!DOCTYPE html>
<html lang="uk" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—á–∏—â—É–≤–∞—á HTML (MVP) ‚Äî –≤–µ—Ä—Å—ñ—è 19</title>

  <!-- ============================== STYLES ============================== -->
  <style>
    /* THEME TOKENS */
    :root{
      --gap:14px;
      --radius:12px;
      --code-font:14px;
      /* dark */
      --bg:#0b1020;
      --panel:#0f1630;
      --panel-2:#121a3a;
      --text:#e7ecf7;
      --muted:#9fb0e0;
      --border:#1b2445;
      --accent:#2952ff;
      --accent-2:#4669ff;
      --code-bg:#0a112b;
      --code-text:#d7e1ff;
      --input-bg:#0a112b;
    }
    /* light overrides */
    html[data-theme="light"]{
      --bg:#f7f8fb;
      --panel:#ffffff;
      --panel-2:#f2f5ff;
      --text:#0e1222;
      --muted:#33406d;
      --border:#dfe7ff;
      --accent:#1d4ed8;
      --accent-2:#3b82f6;
      --code-bg:#0b1020;
      --code-text:#e7ecf7;
      --input-bg:#ffffff;
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}

    header{position:sticky;top:0;z-index:5;padding:14px 18px;border-bottom:1px solid var(--border);background:var(--panel)}
    header .row{display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:18px;font-weight:700}
    /* Theme toggle */
    .theme-toggle{margin-left:auto;display:inline-flex;align-items:center;gap:8px}
    .switch{appearance:none;width:44px;height:26px;border-radius:999px;background:var(--border);position:relative;cursor:pointer;outline:none;border:1px solid var(--border)}
    .switch:before{content:"";position:absolute;top:2px;left:2px;width:20px;height:20px;border-radius:50%;background:#fff;transition:left .18s ease}
    html[data-theme="light"] .switch:before{left:22px}
    .theme-label{font-size:12px;color:var(--muted)}
    .theme-ico{font-size:14px;opacity:.85}

    .wrap{padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    @media (max-width:1100px){.wrap{grid-template-columns:1fr}}

    /* Panels */
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);display:flex;flex-direction:column;min-height:380px;overflow:hidden}
    .panel h2{margin:0;padding:12px 12px;font-size:14px;border-bottom:1px solid var(--border);background:var(--panel-2)}
    .toolbar{display:flex;flex-wrap:wrap;gap:6px;padding:10px 10px 8px;border-bottom:1px solid var(--border);background:var(--panel)}
    .toolbar button,.toolbar select{background:transparent;color:var(--text);border:1px solid var(--border);border-radius:9px;padding:6px 10px;font-size:13px;cursor:pointer}
    .toolbar button:hover,.toolbar select:hover{background:var(--panel-2)}
    .toolbar button:active{transform:translateY(1px)}

    #editor{padding:12px;height:520px;outline:none;line-height:1.5;overflow:auto;resize:vertical;color:var(--text)}
    /* placeholder */
    #editor:empty:before{content:'–í—Å—Ç–∞–≤—Ç–µ –∞–±–æ –Ω–∞–ø–∏—à—ñ—Ç—å —Ç–µ–∫—Å—Ç —Ç—É—Ç‚Ä¶';color:var(--muted)}

    #code{width:100%;padding:12px;height:520px;background:var(--code-bg);color:var(--code-text);border:0;resize:vertical;outline:none;overflow:auto;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:var(--code-font);line-height:1.5}

    .foot-btns{display:flex;gap:8px;padding:10px;border-top:1px solid var(--border);background:var(--panel)}
    .btn{background:var(--accent);border:1px solid var(--accent-2);color:#fff;padding:9px 12px;border-radius:10px;font-size:14px;cursor:pointer}
    .btn.secondary{background:transparent;border-color:var(--border);color:var(--text)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Options + Find */
    .lower{grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    @media (max-width:1100px){.lower{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px 8px}
    .card h3{margin:4px 0 8px;font-size:14px;font-weight:700}
    .card .sub{display:block;margin:-4px 0 8px;font-size:12px;color:var(--muted)}
    .options{columns:2;column-gap:22px}
    .options label{display:block;break-inside:avoid;margin:6px 0;font-size:13px;cursor:pointer}
    .options input{margin-right:6px}

    .find-row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin:8px 0}
    .find-row input{background:var(--input-bg);color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:13px}
    .hr{border-top:1px dashed var(--border);margin:8px 0}

    /* White-list section */
    .whitelist{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .wl-col{background:var(--panel);border:1px dashed var(--border);border-radius:10px;padding:8px 10px}
    .wl-col h4{margin:0 0 6px;font-size:13px}
    .wl-col label{display:block;font-size:13px;margin:4px 0;opacity:.95}
    .wl-off .wl-col label{opacity:.45;pointer-events:none}
  </style>
</head>
<body>

  <!-- ============================== HEADER ============================== -->
  <header>
    <div class="row">
      <h1>–û—á–∏—â—É–≤–∞—á HTML (MVP) ‚Äî –≤–µ—Ä—Å—ñ—è 19</h1>

      <!-- theme toggle -->
      <div class="theme-toggle">
        <span class="theme-ico" id="themeIcon">üåô</span>
        <input id="themeSwitch" class="switch" type="checkbox" aria-label="–ü–µ—Ä–µ–º–∫–Ω—É—Ç–∏ —Ç–µ–º—É">
        <span class="theme-label" id="themeLabel">–ù—ñ—á–Ω–∞ —Ç–µ–º–∞</span>
      </div>
    </div>
  </header>

  <!-- =============================== BODY =============================== -->
  <main class="wrap">
    <!-- LEFT: WYSIWYG -->
    <section class="panel" aria-label="–¢–µ–∫—Å—Ç">
      <h2>–¢–µ–∫—Å—Ç</h2>
      <div class="toolbar" aria-label="–ó–∞—Å–æ–±–∏ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è">
        <select id="blockFormat" title="–§–æ—Ä–º–∞—Ç –±–ª–æ–∫—É">
          <option value="p">–ê–±–∑–∞—Ü</option><option value="h1">H1</option>
          <option value="h2">H2</option><option value="h3">H3</option>
          <option value="h4">H4</option><option value="blockquote">–¶–∏—Ç–∞—Ç–∞</option>
          <option value="pre">Pre</option>
        </select>
        <button type="button" data-cmd="bold"><b>B</b></button>
        <button type="button" data-cmd="italic"><i>I</i></button>
        <button type="button" data-cmd="underline"><u>U</u></button>
        <button type="button" data-cmd="strikeThrough" title="–ó–∞–∫—Ä–µ—Å–ª–µ–Ω–∏–π">S</button>
        <button type="button" data-cmd="superscript" title="–ù–∞–¥—Ä—è–¥–∫–æ–≤–∏–π">x¬≤</button>
        <button type="button" data-cmd="subscript" title="–ü—ñ–¥—Ä—è–¥–∫–æ–≤–∏–π">x‚ÇÇ</button>
        <button type="button" data-cmd="justifyLeft" title="–õ—ñ–≤–æ—Ä—É—á">‚ü∏</button>
        <button type="button" data-cmd="justifyCenter" title="–ü–æ —Ü–µ–Ω—Ç—Ä—É">‚â°</button>
        <button type="button" data-cmd="justifyRight" title="–ü—Ä–∞–≤–æ—Ä—É—á">‚üπ</button>
        <button type="button" data-cmd="justifyFull" title="–ü–æ —à–∏—Ä–∏–Ω—ñ">‚Üî</button>
        <button type="button" data-cmd="insertUnorderedList">‚Ä¢ –°–ø–∏—Å–æ–∫</button>
        <button type="button" data-cmd="insertOrderedList">1. –°–ø–∏—Å–æ–∫</button>
        <button type="button" id="mkLink">–ü–æ—Å–∏–ª–∞–Ω–Ω—è</button>
        <button type="button" id="rmLink">–ü—Ä–∏–±—Ä–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è</button>
        <button type="button" id="insImg" title="–í—Å—Ç–∞–≤–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è">–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è</button>
        <button type="button" id="clearFmt" title="–û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è">–û—á–∏—Å—Ç–∏—Ç–∏</button>
      </div>
      <div id="editor" contenteditable="true"></div>
    </section>

    <!-- RIGHT: CODE -->
    <section class="panel" aria-label="HTML-–∫–æ–¥">
      <h2>HTML-–∫–æ–¥</h2>
      <textarea id="code" spellcheck="false" placeholder="–¢—É—Ç –∑‚Äô—è–≤–∏—Ç—å—Å—è HTML‚Ä¶"></textarea>
      <div class="foot-btns">
        <button class="btn" id="btnClean">–û—á–∏—Å—Ç–∏—Ç–∏</button>
        <button class="btn secondary" id="btnUndo" disabled>–ù–∞–∑–∞–¥</button>
        <button class="btn secondary" id="fontPlus" title="–ó–±—ñ–ª—å—à–∏—Ç–∏ —à—Ä–∏—Ñ—Ç">A+</button>
        <button class="btn secondary" id="fontMinus" title="–ó–º–µ–Ω—à–∏—Ç–∏ —à—Ä–∏—Ñ—Ç">A‚àí</button>
        <button class="btn" id="btnCopy">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
      </div>
    </section>

    <!-- LOWER: OPTIONS -->
    <section class="lower">
      <!-- cleaning options -->
      <div class="card">
        <h3>–û–ø—Ü—ñ—ó –æ—á–∏—â–µ–Ω–Ω—è</h3>
        <div class="options" id="options">
          <label><input type="checkbox" id="opt-remove-attrs"> –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å—ñ –∞—Ç—Ä–∏–±—É—Ç–∏ —Ç–µ–≥—ñ–≤</label>
          <label><input type="checkbox" id="opt-remove-inline"> –í–∏–¥–∞–ª–∏—Ç–∏ inline-—Å—Ç–∏–ª—ñ</label>
          <label><input type="checkbox" id="opt-remove-class-id"> –í–∏–¥–∞–ª–∏—Ç–∏ –∫–ª–∞—Å–∏ —Ç–∞ ID</label>
          <label><input type="checkbox" id="opt-remove-empty"> –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Ä–æ–∂–Ω—ñ —Ç–µ–≥–∏</label>
          <label><input type="checkbox" id="opt-remove-links"> –í–∏–¥–∞–ª–∏—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è (–∑–∞–ª–∏—à–∏—Ç–∏ —Ç–µ–∫—Å—Ç)</label>
          <label><input type="checkbox" id="opt-remove-images"> –í–∏–¥–∞–ª–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è</label>
          <label><input type="checkbox" id="opt-remove-tables"> –†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ —Ç–∞–±–ª–∏—Ü—ñ (–∑–∞–ª–∏—à–∏—Ç–∏ –≤–º—ñ—Å—Ç)</label>
          <label><input type="checkbox" id="opt-table-to-empty-p"> –ó–∞–º—ñ–Ω–∏—Ç–∏ —Ç–µ–≥–∏ —Ç–∞–±–ª–∏—Ü—å –Ω–∞ –ø–æ—Ä–æ–∂–Ω—ñ &lt;p&gt;</label>
          <label><input type="checkbox" id="opt-remove-p-in-tables"> –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–≥–∏ &lt;p&gt; —É —Ç–∞–±–ª–∏—Ü—è—Ö</label>
          <label><input type="checkbox" id="opt-nbsp-to-space"> –ó–∞–º—ñ–Ω–∏—Ç–∏ &amp;nbsp; –Ω–∞ –ø—Ä–æ–±—ñ–ª (—Å—Ç–∏—Å–Ω—É—Ç–∏ –¥–æ –æ–¥–Ω–æ–≥–æ)</label>
          <label><input type="checkbox" id="opt-strong-to-h2"> –ó–∞–º—ñ–Ω–∏—Ç–∏ &lt;strong&gt; –Ω–∞ &lt;h2&gt;</label>
          <label><input type="checkbox" id="opt-em-to-h3"> –ó–∞–º—ñ–Ω–∏—Ç–∏ &lt;em&gt;/&lt;i&gt; –Ω–∞ &lt;h3&gt;</label>
          <label><input type="checkbox" id="opt-remove-span"> –í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ–≥ &lt;span&gt;</label>
          <div class="hr"></div>
          <label><input type="checkbox" id="opt-whitelist-master"> –ó–∞–ª–∏—à–∏—Ç–∏ –ë—ñ–ª–∏–π —Å–ø–∏—Å–æ–∫ —Ç–µ–≥—ñ–≤ (–≤—Å–µ —ñ–Ω—à–µ —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç–∏)</label>
          <div id="whiteList" class="whitelist wl-off" aria-disabled="true">
            <div class="wl-col">
              <h4>–¢–µ–∫—Å—Ç —Ç–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∏</h4>
              <label><input type="checkbox" class="wl" value="p"   checked> &lt;p&gt; ‚Äî –∞–±–∑–∞—Ü</label>
              <label><input type="checkbox" class="wl" value="h1"  checked> &lt;h1&gt; ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫ 1</label>
              <label><input type="checkbox" class="wl" value="h2"  checked> &lt;h2&gt; ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫ 2</label>
              <label><input type="checkbox" class="wl" value="h3"  checked> &lt;h3&gt; ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫ 3</label>
              <label><input type="checkbox" class="wl" value="strong" checked> &lt;strong&gt; ‚Äî –∂–∏—Ä–Ω–∏–π</label>
              <label><input type="checkbox" class="wl" value="em" checked> &lt;em&gt; ‚Äî –∫—É—Ä—Å–∏–≤</label>
              <label><input type="checkbox" class="wl" value="a" checked> &lt;a&gt; ‚Äî –ø–æ—Å–∏–ª–∞–Ω–Ω—è</label>
            </div>
            <div class="wl-col">
              <h4>–°–ø–∏—Å–∫–∏</h4>
              <label><input type="checkbox" class="wl" value="ul" checked> &lt;ul&gt; ‚Äî –º–∞—Ä–∫–æ–≤–∞–Ω–∏–π —Å–ø–∏—Å–æ–∫</label>
              <label><input type="checkbox" class="wl" value="ol" checked> &lt;ol&gt; ‚Äî –Ω—É–º–µ—Ä–æ–≤–∞–Ω–∏–π —Å–ø–∏—Å–æ–∫</label>
              <label><input type="checkbox" class="wl" value="li" checked> &lt;li&gt; ‚Äî –ø—É–Ω–∫—Ç —Å–ø–∏—Å–∫—É</label>
            </div>
          </div>
        </div>
      </div>

      <!-- find/replace -->
      <div class="card">
        <h3>–ü–æ—à—É–∫ —ñ –∑–∞–º—ñ–Ω–∞ —É –≤–∏—Ö—ñ–¥–Ω–æ–º—É HTML</h3>
        <span class="sub">–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –ø—ñ—Å–ª—è –æ—á–∏—â–µ–Ω–Ω—è; –ø–æ–ª—è <b>—á—É—Ç–ª–∏–≤—ñ –¥–æ —Ä–µ–≥—ñ—Å—Ç—Ä—É</b>.</span>
        <div id="findBox"></div>
        <button class="btn secondary" id="btnAddRow">+ –î–æ–¥–∞—Ç–∏ –ø–æ–ª–µ</button>
      </div>
    </section>
  </main>

  <!-- ============================== SCRIPTS ============================== -->
  <script>
    /* ---------- Theme toggle ---------- */
    const themeSwitch = document.getElementById('themeSwitch');
    const themeIcon   = document.getElementById('themeIcon');
    const themeLabel  = document.getElementById('themeLabel');
    (function initTheme(){
      const saved = localStorage.getItem('html-cleaner-theme');
      if(saved === 'light'){ document.documentElement.setAttribute('data-theme','light'); themeSwitch.checked = true; }
      renderThemeLabel();
    })();
    themeSwitch.addEventListener('change', () => {
      const light = themeSwitch.checked;
      document.documentElement.setAttribute('data-theme', light ? 'light' : 'dark');
      localStorage.setItem('html-cleaner-theme', light ? 'light' : 'dark');
      renderThemeLabel();
    });
    function renderThemeLabel(){
      const light = document.documentElement.getAttribute('data-theme') === 'light';
      themeIcon.textContent = light ? '‚òÄÔ∏è' : 'üåô';
      themeLabel.textContent = light ? '–î–µ–Ω–Ω–∞ —Ç–µ–º–∞' : '–ù—ñ—á–Ω–∞ —Ç–µ–º–∞';
    }

    /* ---------- Elements ---------- */
    const editor = document.getElementById('editor');
    const codeArea = document.getElementById('code');
    const undoBtn = document.getElementById('btnUndo');
    const blockFormat = document.getElementById('blockFormat');
    const mkLink   = document.getElementById('mkLink');
    const rmLink   = document.getElementById('rmLink');
    const insImg   = document.getElementById('insImg');
    const clearFmt = document.getElementById('clearFmt');
    const fontPlus = document.getElementById('fontPlus');
    const fontMinus= document.getElementById('fontMinus');
    const btnCopy  = document.getElementById('btnCopy');

    /* ---------- Toolbar ---------- */
    document.querySelectorAll('.toolbar [data-cmd]').forEach(btn=>{
      btn.addEventListener('click',()=>{ document.execCommand(btn.dataset.cmd,false); editor.focus(); syncToCode(); });
    });
    blockFormat.addEventListener('change',()=>{ document.execCommand('formatBlock',false,blockFormat.value); editor.focus(); syncToCode(); });
    mkLink.addEventListener('click',()=>{ const u=prompt('–ü–æ—Å–∏–ª–∞–Ω–Ω—è (URL):','https://'); if(!u) return; document.execCommand('createLink',false,u); syncToCode(); });
    rmLink.addEventListener('click',()=>{ document.execCommand('unlink'); syncToCode(); });
    insImg.addEventListener('click',()=>{ const u=prompt('URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è:','https://'); if(!u) return; document.execCommand('insertImage',false,u); syncToCode(); });
    clearFmt.addEventListener('click',()=>{ document.execCommand('removeFormat'); editor.querySelectorAll('span').forEach(s=>s.replaceWith(...s.childNodes)); syncToCode(); });

    /* ---------- Live mirror ---------- */
    const undoStack=[];
    function syncToCode(){ codeArea.value = prettyHtml(editor.innerHTML); }
    editor.addEventListener('input', syncToCode);
    editor.addEventListener('paste', ()=> setTimeout(()=>{ glueMarks(editor); syncToCode(); }));

    /* ---------- Code pane font ---------- */
    function updCodeFont(d){ const s=getComputedStyle(document.documentElement).getPropertyValue('--code-font').trim(); const n=parseInt(s||'14',10)+d; document.documentElement.style.setProperty('--code-font',Math.max(10,Math.min(28,n))+'px'); }
    fontPlus.addEventListener('click',()=>updCodeFont(+1));
    fontMinus.addEventListener('click',()=>updCodeFont(-1));

    /* ---------- Copy ---------- */
    btnCopy.addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText(codeArea.value); btnCopy.textContent='–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!'; setTimeout(()=>btnCopy.textContent='–ö–æ–ø—ñ—é–≤–∞—Ç–∏',1200);}catch(e){ codeArea.select(); document.execCommand('copy'); } });

    /* ---------- Undo for code ---------- */
    function pushUndo(){ undoStack.push(codeArea.value); undoBtn.disabled=false; }
    undoBtn.addEventListener('click',()=>{ if(!undoStack.length) return; codeArea.value=undoStack.pop(); if(!undoStack.length) undoBtn.disabled=true; });

    /* ---------- Find/Replace UI ---------- */
    const findBox = document.getElementById('findBox');
    function addFindRow(findVal='',replVal=''){
      const row=document.createElement('div'); row.className='find-row';
      row.innerHTML = `<input type="text" placeholder="–©–æ –∑–Ω–∞–π—Ç–∏" value="${findVal.replaceAll('"','&quot;')}">`+
                      `<input type="text" placeholder="–ù–∞ —â–æ –∑–∞–º—ñ–Ω–∏—Ç–∏" value="${replVal.replaceAll('"','&quot;')}">`+
                      `<button type="button" class="btn secondary">–í–∏–¥–∞–ª–∏—Ç–∏</button>`;
      row.lastElementChild.addEventListener('click',()=>row.remove());
      findBox.appendChild(row);
    }
    document.getElementById('btnAddRow').addEventListener('click',()=>addFindRow());
    addFindRow();

    /* ---------- Helpers ---------- */
    function unwrap(el){ const p=el.parentNode; if(!p) return; while(el.firstChild) p.insertBefore(el.firstChild,el); p.removeChild(el); }
    function replaceTag(el,tag){ const neo=document.createElement(tag); while(el.firstChild) neo.appendChild(el.firstChild); el.replaceWith(neo); return neo; }
    function qAll(root,sel){ return Array.from(root.querySelectorAll(sel)); }

    /* –°–∫–ª–µ—é–≤–∞–Ω–Ω—è —Å–ª—É–∂–µ–±–Ω–∏—Ö —Å–∏–º–≤–æ–ª—ñ–≤ ¬Æ ‚Ñ¢ ‚Ñ† –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–º —Å–ª–æ–≤–æ–º */
    function glueMarks(root){
      const walker=document.createTreeWalker(root,NodeFilter.SHOW_TEXT,null);
      const MARK=/^[\s\u00A0]*[¬Æ‚Ñ¢‚Ñ†][\s\u00A0]*$/;
      const TRIM=/^[\s\u00A0]+|[\s\u00A0]+$/g;
      let n; while(n=walker.nextNode()){
        if(MARK.test(n.nodeValue)){
          const prev = n.previousSibling;
          if(prev && prev.nodeType===3){
            prev.nodeValue = (prev.nodeValue||'').replace(TRIM,'') + n.nodeValue.replace(TRIM,'');
            n.nodeValue='';
          }else if(prev && prev.nodeType===1){
            prev.appendChild(document.createTextNode(n.nodeValue.replace(TRIM,'')));
            n.nodeValue='';
          }
        }
      }
      // –ø—Ä–∏–±–∏—Ä–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ —Ç–µ–∫—Å—Ç-–Ω–æ–¥–∏
      qAll(root,'*').forEach(el=>{ for(const t of Array.from(el.childNodes)){ if(t.nodeType===3 && !t.nodeValue.trim()) el.removeChild(t); }});
    }

    /* –ì–∞—Ä–Ω–µ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è: –û–î–ò–ù —Ç–µ–≥/—Ä—è–¥–æ–∫ (—è–∫ —Ö–æ—Ç—ñ–≤) */
    function prettyHtml(html){
      try{
        html=String(html);
        const tokens=[]; let i=0;
        while(i<html.length){
          const lt=html.indexOf('<',i);
          if(lt<0){ const tail=html.slice(i); if(tail.trim()) tokens.push(tail); break; }
          const text=html.slice(i,lt); if(text.trim()) tokens.push(text);
          const gt=html.indexOf('>',lt+1); if(gt<0){ tokens.push(html.slice(lt)); break; }
          tokens.push(html.slice(lt,gt+1)); i=gt+1;
        }
        const voids=new Set(['area','base','br','col','embed','hr','img','input','link','meta','param','source','track','wbr']);
        const blocks=new Set(['html','head','body','div','p','h1','h2','h3','h4','h5','h6','ul','ol','li','table','thead','tbody','tfoot','tr','td','th','section','article','header','footer','nav','blockquote','pre','figure','figcaption','hr']);
        const isTag=t=>t.startsWith('<')&&t.endsWith('>');
        const tag=(t)=>{let j=t[1]==='/'?2:1, n=''; for(;j<t.length;j++){const c=t[j]; if(c===' '||c==='>'||c=== '/') break; n+=c;} return n.toLowerCase(); };
        const isClose=t=>t[1]==='/'; const isSelf=t=>t[t.length-2]==='/';
        let indent=0, out=[];
        for(const t of tokens){
          if(isTag(t)){
            const nm=tag(t), close=isClose(t), self=isSelf(t)||voids.has(nm), isBlock=blocks.has(nm);
            if(close && isBlock) indent=Math.max(0,indent-1);
            out.push('  '.repeat(indent)+t);
            if(!close && isBlock && !self) indent++;
          }else{
            const tx=t.trim(); if(tx) out.push('  '.repeat(indent)+tx);
          }
        }
        return out.join('\n').trim();
      }catch(e){ return String(html); }
    }

    /* ---------- White-list enable/disable ---------- */
    const wlMaster=document.getElementById('opt-whitelist-master');
    const wlBox=document.getElementById('whiteList');
    wlMaster.addEventListener('change',()=>{ wlBox.classList.toggle('wl-off', !wlMaster.checked); wlBox.setAttribute('aria-disabled', wlMaster.checked?'false':'true'); });

    /* =========================== CLEAN PIPELINE =========================== */
    document.getElementById('btnClean').addEventListener('click',()=>{
      pushUndo();
      let html = codeArea.value || editor.innerHTML || '';

      // DOM parse
      const parser=new DOMParser();
      const doc=parser.parseFromString(`<div id="__root">${html}</div>`,'text/html');
      const root=doc.getElementById('__root');

      // OPTIONS
      const opts={
        removeAttrs:document.getElementById('opt-remove-attrs').checked,
        removeInline:document.getElementById('opt-remove-inline').checked,
        removeClassId:document.getElementById('opt-remove-class-id').checked,
        removeEmpty:document.getElementById('opt-remove-empty').checked,
        removeLinks:document.getElementById('opt-remove-links').checked,
        removeImages:document.getElementById('opt-remove-images').checked,
        removeTables:document.getElementById('opt-remove-tables').checked,
        tableToEmptyP:document.getElementById('opt-table-to-empty-p').checked,
        removePInTables:document.getElementById('opt-remove-p-in-tables').checked,
        nbspToSpace:document.getElementById('opt-nbsp-to-space').checked,
        strongToH2:document.getElementById('opt-strong-to-h2').checked,
        emToH3:document.getElementById('opt-em-to-h3').checked,
        removeSpan:document.getElementById('opt-remove-span').checked,
        wlEnabled:document.getElementById('opt-whitelist-master').checked,
        wlTags:Array.from(document.querySelectorAll('#whiteList .wl:checked')).map(i=>i.value)
      };

      /* 1) structural DOM operations */
      if(opts.removeImages) qAll(root,'img').forEach(el=>el.remove());
      if(opts.removeLinks)  qAll(root,'a').forEach(el=>unwrap(el));
      if(opts.removePInTables) qAll(root,'table p,thead p,tbody p,tr p,td p,th p').forEach(p=>unwrap(p));
      if(opts.strongToH2) qAll(root,'strong').forEach(el=>replaceTag(el,'h2'));
      if(opts.emToH3) qAll(root,'em,i').forEach(el=>replaceTag(el,'h3'));
      if(opts.tableToEmptyP) qAll(root,'table,thead,tbody,tr,td,th').forEach(el=>el.replaceWith(document.createElement('p')));
      if(opts.removeTables) qAll(root,'table,thead,tbody,tr,td,th').forEach(el=>unwrap(el));
      if(opts.removeSpan) qAll(root,'span').forEach(el=>unwrap(el));

      if(opts.removeInline) qAll(root,'[style]').forEach(el=>el.removeAttribute('style'));
      if(opts.removeClassId){ qAll(root,'[class]').forEach(el=>el.removeAttribute('class')); qAll(root,'[id]').forEach(el=>el.removeAttribute('id')); }
      if(opts.removeAttrs) qAll(root,'*').forEach(el=>{ [...el.attributes].forEach(a=>el.removeAttribute(a.name)); });

      // normalize empty p sequences
      (function normalizeP(){
        qAll(root,'p p').forEach(inner=>unwrap(inner));
        const blank=el=>(!el.textContent||el.textContent.replace(/\u00A0|\s/g,'')==='') && !el.firstElementChild;
        let changed; do{
          changed=false;
          const ps=qAll(root,'p');
          for(let i=0;i<ps.length-1;i++){ const a=ps[i], b=ps[i+1]; if(blank(a)&&blank(b)){ b.remove(); changed=true; break; } }
        }while(changed);
      })();

      // 2) if whitelist is ON: unwrap everything except allowed tags
      if(opts.wlEnabled){
        const keep=new Set(opts.wlTags.map(x=>x.toLowerCase()));
        qAll(root,'*').forEach(el=>{
          const name=el.tagName.toLowerCase();
          if(!keep.has(name)) unwrap(el);
        });
      }

      // 3) serialize
      html = root.innerHTML;

      // NBSP handling: replace all and compress sequences to one space
      if(opts.nbspToSpace){ html = html.replace(/(?:&nbsp;|\u00A0)+/g,' '); }

      // user find/replace
      const rows=Array.from(findBox.querySelectorAll('.find-row'));
      for(const row of rows){
        const [a,b]=row.querySelectorAll('input'); const f=a.value; if(!f) continue; const r=b.value;
        const esc=f.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); html = html.replace(new RegExp(esc,'g'), r);
      }

      codeArea.value = prettyHtml(html);
    });

    /* initial content */
    editor.innerHTML='<p><strong>–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ!</strong> –í—Å—Ç–∞–≤—Ç–µ —Ç–µ–∫—Å—Ç –ª—ñ–≤–æ—Ä—É—á. –ü—Ä–∞–≤–æ—Ä—É—á –∑‚Äô—è–≤–∏—Ç—å—Å—è HTML-–∫–æ–¥. –û–±–µ—Ä—ñ—Ç—å –æ–ø—Ü—ñ—ó –æ—á–∏—â–µ–Ω–Ω—è —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å <em>–û—á–∏—Å—Ç–∏—Ç–∏</em>.</p>';
    syncToCode();
  </script>
</body>
</html>
