<!DOCTYPE html>
<html lang="uk" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Очищувач HTML — MVP</title>
  <style>
    :root{
      --gap:14px; --code-font-size:14px;
      /* DARK */
      --bg:#0b1020; --panel:#0f1630; --panel-2:#121a3a; --stroke:#1b2445;
      --ink:#e7ecf7; --ink-dim:#9fb0d8; --code-bg:#0a112b; --brand:#2952ff; --brand-2:#4669ff;
      /* LIGHT */
      --bg-l:#f6f8ff; --panel-l:#ffffff; --panel-2-l:#eef2ff; --stroke-l:#dfe5ff;
      --ink-l:#0f1a2c; --ink-dim-l:#4a5b86; --code-bg-l:#f5f7ff;
    }
    [data-theme="dark"]{
      --B:var(--bg); --P:var(--panel); --P2:var(--panel-2);
      --S:var(--stroke); --I:var(--ink); --ID:var(--ink-dim); --CB:var(--code-bg);
    }
    [data-theme="light"]{
      --B:var(--bg-l); --P:var(--panel-l); --P2:var(--panel-2-l);
      --S:var(--stroke-l); --I:var(--ink-l); --ID:var(--ink-dim-l); --CB:var(--code-bg-l);
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--B);color:var(--I)}
    header{padding:14px 18px;border-bottom:1px solid var(--S);background:var(--P);position:sticky;top:0;z-index:5;display:flex;align-items:center;gap:12px}
    header h1{margin:0; font-size:18px; font-weight:600}
    #themeBtn{margin-left:auto;background:transparent;border:1px solid var(--S);color:var(--I);padding:6px 10px;border-radius:8px;cursor:pointer}

    .wrap{padding:16px;display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    .panel{background:var(--P);border:1px solid var(--S);border-radius:10px;display:flex;flex-direction:column;min-height:380px;overflow:hidden}
    .panel h2{margin:0;padding:12px 12px;font-size:14px;border-bottom:1px solid var(--S);background:var(--P2)}
    .toolbar{display:flex;flex-wrap:wrap;gap:6px;padding:10px 10px 8px;border-bottom:1px solid var(--S);background:var(--P)}
    .toolbar button,.toolbar select{background:transparent;color:var(--I);border:1px solid var(--S);border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}
    .toolbar button:hover,.toolbar select:hover{background:rgba(100,120,200,.12)}

    #editor{padding:12px;height:520px;outline:none;line-height:1.5;overflow:auto;resize:vertical}
    #editor:empty:before{content:'Вставте або напишіть текст тут…';color:var(--ID)}
    #code{width:100%;padding:12px;height:520px;background:var(--CB);color:var(--I);border:0;resize:vertical;outline:none;overflow:auto;
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:var(--code-font-size);line-height:1.5}

    .foot-btns{display:flex;gap:8px;padding:10px;border-top:1px solid var(--S);background:var(--P)}
    .btn{background:var(--brand);border:1px solid var(--brand-2);color:#fff;padding:9px 12px;border-radius:10px;font-size:14px;cursor:pointer}
    .btn.secondary{background:transparent;border-color:var(--S);color:var(--I)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .lower{grid-column:1/-1;display:grid;grid-template-columns:1fr 1fr;gap:var(--gap)}
    .card{background:var(--P);border:1px solid var(--S);border-radius:10px;padding:10px 12px 8px}
    .card h3{margin:4px 0 10px;font-size:14px;font-weight:600}
    .card .sub{display:block;margin:-6px 0 8px;opacity:.8;font-size:12px}
    .options{columns:2;column-gap:22px}
    .options label{display:block;break-inside:avoid;margin:6px 0;font-size:13px;cursor:pointer}
    .options input{margin-right:6px}
    .find-row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin:8px 0}
    .find-row input{background:var(--CB);color:var(--I);border:1px solid var(--S);border-radius:8px;padding:8px 10px;font-size:13px}
    .hr{border-top:1px dashed var(--S);margin:10px 0}

    /* блок «білий список» */
    .wl-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .wl-col h4{margin:8px 0 6px;font-size:13px;font-weight:600;color:var(--ID)}
    .wl-col label{display:block;margin:4px 0;font-size:13px}

    @media (max-width:1100px){.wrap{grid-template-columns:1fr}.lower{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>Очищувач HTML (MVP)</h1>
    <button id="themeBtn" title="Перемкнути тему">Нічна тема</button>
  </header>

  <main class="wrap">
    <!-- Ліва панель -->
    <section class="panel" aria-label="Текст">
      <h2>Текст</h2>
      <div class="toolbar" aria-label="Засоби форматування">
        <select id="blockFormat" title="Формат блоку">
          <option value="p">Абзац</option><option value="h1">H1</option><option value="h2">H2</option><option value="h3">H3</option>
        </select>
        <button type="button" data-cmd="bold"><b>B</b></button>
        <button type="button" data-cmd="italic"><i>I</i></button>
        <button type="button" data-cmd="underline"><u>U</u></button>
        <button type="button" data-cmd="insertUnorderedList">• Список</button>
        <button type="button" data-cmd="insertOrderedList">1. Список</button>
        <button type="button" id="mkLink">Посилання</button>
        <button type="button" id="rmLink">Прибрати посилання</button>
        <button type="button" id="clearFmt">Очистити</button>
      </div>
      <div id="editor" contenteditable="true"></div>
    </section>

    <!-- Права панель -->
    <section class="panel" aria-label="HTML-код">
      <h2>HTML-код</h2>
      <textarea id="code" spellcheck="false" placeholder="Тут з’явиться HTML…"></textarea>
      <div class="foot-btns">
        <button class="btn" id="btnClean">Очистити</button>
        <button class="btn secondary" id="btnUndo" disabled>Назад</button>
        <button class="btn secondary" id="fontPlus" title="Збільшити шрифт">A+</button>
        <button class="btn secondary" id="fontMinus" title="Зменшити шрифт">A−</button>
        <button class="btn" id="btnCopy">Копіювати</button>
      </div>
    </section>

    <!-- Нижній блок -->
    <section class="lower">
      <div class="card">
        <h3>Опції очищення</h3>
        <div class="options" id="options">
          <label><input type="checkbox" id="opt-remove-inline"> Видалити inline-стилі</label>
          <label><input type="checkbox" id="opt-remove-class-id"> Прибрати класи та ID</label>
          <label><input type="checkbox" id="opt-remove-empty"> Видалити порожні теги</label>
          <label><input type="checkbox" id="opt-remove-links"> Видалити посилання (залишити текст)</label>
          <label><input type="checkbox" id="opt-remove-images"> Видалити зображення</label>
          <label><input type="checkbox" id="opt-nbsp-to-space"> Замінити &amp;nbsp; на пробіл (стиснути до одного)</label>
          <div class="hr"></div>
          <label><input type="checkbox" id="opt-strong-to-h2"> Замінити &lt;strong&gt; на &lt;h2&gt;</label>
          <label><input type="checkbox" id="opt-em-to-h3"> Замінити &lt;em&gt;/&lt;i&gt; на &lt;h3&gt;</label>
        </div>
      </div>

      <div class="card">
        <h3>Залишити Білий список тегів</h3>
        <span class="sub">Коли увімкнено — залишимо лише обрані теги, решту розгорнемо.</span>
        <label style="margin-bottom:8px"><input type="checkbox" id="wl-enable"> Увімкнути Білий список</label>
        <div class="wl-grid" id="wl-box" aria-disabled="true">
          <div class="wl-col">
            <h4>Текст та заголовки</h4>
            <label><input type="checkbox" class="wl-tag" value="p"> &lt;p&gt; — абзац</label>
            <label><input type="checkbox" class="wl-tag" value="h1"> &lt;h1&gt; — заголовок 1</label>
            <label><input type="checkbox" class="wl-tag" value="h2"> &lt;h2&gt; — заголовок 2</label>
            <label><input type="checkbox" class="wl-tag" value="h3"> &lt;h3&gt; — заголовок 3</label>
            <label><input type="checkbox" class="wl-tag" value="strong"> &lt;strong&gt; — жирний</label>
            <label><input type="checkbox" class="wl-tag" value="em"> &lt;em&gt; — курсив</label>
            <label><input type="checkbox" class="wl-tag" value="a"> &lt;a&gt; — посилання</label>
          </div>
          <div class="wl-col">
            <h4>Списки</h4>
            <label><input type="checkbox" class="wl-tag" value="ul"> &lt;ul&gt; — маркований</label>
            <label><input type="checkbox" class="wl-tag" value="ol"> &lt;ol&gt; — нумерований</label>
            <label><input type="checkbox" class="wl-tag" value="li"> &lt;li&gt; — пункт списку</label>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Пошук і заміна у вихідному HTML</h3>
        <span class="sub">Виконується після очищення; поля чутливі до регістру.</span>
        <div id="findBox"></div>
        <button class="btn secondary" id="btnAddRow">+ Додати поле</button>
      </div>
    </section>
  </main>

  <script>
    /* ===== ССЫЛКИ НА ЭЛЕМЕНТЫ ===== */
    const editor   = document.getElementById('editor');
    const codeArea = document.getElementById('code');
    const undoBtn  = document.getElementById('btnUndo');
    const fontPlus = document.getElementById('fontPlus');
    const fontMinus= document.getElementById('fontMinus');
    const btnCopy  = document.getElementById('btnCopy');
    const findBox  = document.getElementById('findBox');

    /* ===== [THEME] Переключатель темы ===== */
    (function themeInit(){
      const btn = document.getElementById('themeBtn');
      const saved = localStorage.getItem('theme');
      if (saved) document.documentElement.setAttribute('data-theme', saved);
      updateThemeBtn();
      btn.addEventListener('click', () => {
        const cur = document.documentElement.getAttribute('data-theme') || 'dark';
        const next = (cur === 'dark') ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        updateThemeBtn();
      });
      function updateThemeBtn(){
        const cur = document.documentElement.getAttribute('data-theme');
        themeBtn.textContent = (cur === 'dark') ? 'Нічна тема' : 'Денна тема';
      }
    })();

    /* ===== Тулбар ===== */
    document.querySelectorAll('.toolbar [data-cmd]').forEach(btn=>{
      btn.addEventListener('click',()=>{document.execCommand(btn.dataset.cmd,false); editor.focus(); syncToCode();});
    });
    blockFormat.addEventListener('change',()=>{document.execCommand('formatBlock',false,blockFormat.value); editor.focus(); syncToCode();});
    mkLink.addEventListener('click',()=>{const url=prompt('Посилання (URL):','https://'); if(!url) return; document.execCommand('createLink',false,url); syncToCode();});
    rmLink.addEventListener('click',()=>{document.execCommand('unlink'); syncToCode();});
    clearFmt.addEventListener('click',()=>{document.execCommand('removeFormat'); editor.querySelectorAll('span').forEach(s=>s.replaceWith(...s.childNodes)); syncToCode();});

    /* ===== Живе дзеркало HTML ===== */
    const undoStack=[];
    function pushUndo(){undoStack.push(codeArea.value); undoBtn.disabled=false;}
    undoBtn.addEventListener('click',()=>{ if(!undoStack.length) return; codeArea.value=undoStack.pop(); if(!undoStack.length) undoBtn.disabled=true;});

    function syncToCode(){ codeArea.value = editor.innerHTML; }
    editor.addEventListener('input', syncToCode);

    /* [PASTE] — при вставке: прибираємо dir="..." */
    editor.addEventListener('paste', (e)=>{
      setTimeout(()=>{
        editor.querySelectorAll('[dir]').forEach(el=>el.removeAttribute('dir')); // ← видаляємо dir
        syncToCode();
      });
    });

    /* Шрифт у правій панелі */
    function updateCodeFont(d){
      const cs=getComputedStyle(document.documentElement).getPropertyValue('--code-font-size').trim();
      const px=parseInt(cs||'14',10)+d;
      document.documentElement.style.setProperty('--code-font-size',Math.max(10,Math.min(28,px))+'px');
    }
    fontPlus.addEventListener('click',()=>updateCodeFont(+1));
    fontMinus.addEventListener('click',()=>updateCodeFont(-1));
    btnCopy.addEventListener('click',async()=>{try{await navigator.clipboard.writeText(codeArea.value); btnCopy.textContent='Скопійовано!'; setTimeout(()=>btnCopy.textContent='Копіювати',1100);}catch(e){codeArea.select();document.execCommand('copy');}});

    /* ===== Find/Replace UI ===== */
    function addFindRow(findVal='',replVal=''){
      const row=document.createElement('div'); row.className='find-row';
      row.innerHTML = `<input type="text" placeholder="Що знайти" value="${findVal.replaceAll('"','&quot;')}">`+
                      `<input type="text" placeholder="На що замінити" value="${replVal.replaceAll('"','&quot;')}">`+
                      `<button class="btn secondary" type="button">Видалити</button>`;
      row.lastElementChild.addEventListener('click',()=>row.remove());
      findBox.appendChild(row);
    }
    document.getElementById('btnAddRow').addEventListener('click',()=>addFindRow());
    addFindRow();

    /* ===== Утиліти DOM ===== */
    const qA = (root,sel)=>Array.from(root.querySelectorAll(sel));
    function unwrap(el){const p=el.parentNode;if(!p)return; while(el.firstChild)p.insertBefore(el.firstChild,el); p.removeChild(el);}
    function replaceTag(el,tag){const neo=document.createElement(tag); while(el.firstChild) neo.appendChild(el.firstChild); el.replaceWith(neo); return neo;}

    /* ===== [WL] Увімкнення/вимкнення чекбоксів для білого списку ===== */
    const wlEnable = document.getElementById('wl-enable');
    const wlBox = document.getElementById('wl-box');
    const wlTags = Array.from(document.querySelectorAll('.wl-tag'));
    function setWLEnabled(on){
      wlBox.style.opacity = on ? '1' : '.5';
      wlBox.style.pointerEvents = on ? 'auto' : 'none';
      wlTags.forEach(cb=>cb.disabled = !on);
    }
    setWLEnabled(false);
    wlEnable.addEventListener('change',()=>setWLEnabled(wlEnable.checked));

    /* ===== Серіалізація «в один рядок на тег» ===== */
    function oneLineSerialize(root){
      const lines=[];
      root.childNodes.forEach(n=>{
        if(n.nodeType===1){ // element
          // прибираємо внутрішні переводи рядка/зайві пробіли
          const clone=n.cloneNode(true);
          // не чіпаємо атрибути (href і т.д.), але стилі прибираємо вже у пайплайні при WL
          const html = clone.innerHTML.replace(/\s*\n+\s*/g,' ').replace(/\s{2,}/g,' ').trim();
          const attrs = Array.from(clone.attributes).map(a=>`${a.name}="${a.value}"`).join(' ');
          lines.push(`<${clone.tagName.toLowerCase()}${attrs?(' '+attrs):''}>${html}</${clone.tagName.toLowerCase()}>`);
        } else if(n.nodeType===3){
          const t=n.textContent.replace(/\s+/g,' ').trim(); if(t) lines.push(t);
        }
      });
      return lines.join('\n');
    }

    /* ===== Пайплайн «Очистити» ===== */
    document.getElementById('btnClean').addEventListener('click', ()=>{
      pushUndo();
      let html = codeArea.value || editor.innerHTML || '';

      // Парсимо у DOM
      const parser = new DOMParser();
      const doc = parser.parseFromString(`<div id="__root">${html}</div>`, 'text/html');
      const root = doc.getElementById('__root');

      // Загальні опції
      const opts = {
        removeInline:  document.getElementById('opt-remove-inline').checked,
        removeClassId: document.getElementById('opt-remove-class-id').checked,
        removeEmpty:   document.getElementById('opt-remove-empty').checked,
        removeLinks:   document.getElementById('opt-remove-links').checked,
        removeImages:  document.getElementById('opt-remove-images').checked,
        nbspToSpace:   document.getElementById('opt-nbsp-to-space').checked,
        strongToH2:    document.getElementById('opt-strong-to-h2').checked,
        emToH3:        document.getElementById('opt-em-to-h3').checked,
        wlEnabled:     wlEnable.checked,
        wlAllowed:     new Set(wlTags.filter(cb=>cb.checked).map(cb=>cb.value))
      };

      // Базові структурні дії
      qA(root,'[dir]').forEach(el=>el.removeAttribute('dir'));  // прибираємо dir завжди
      if (opts.removeImages) qA(root,'img').forEach(el=>el.remove());
      if (opts.removeLinks)  qA(root,'a').forEach(el=>unwrap(el));
      if (opts.strongToH2)   qA(root,'strong').forEach(el=>replaceTag(el,'h2'));
      if (opts.emToH3)       qA(root,'em, i').forEach(el=>replaceTag(el,'h3'));
      if (opts.removeClassId){ qA(root,'[class]').forEach(el=>el.removeAttribute('class')); qA(root,'[id]').forEach(el=>el.removeAttribute('id')); }

      // [WL] — якщо ввімкнено білий список:
      if (opts.wlEnabled){
        // 1) прибираємо стилі
        qA(root,'[style]').forEach(el=>el.removeAttribute('style'));
        // 2) залишаємо лише дозволені теги → все інше розгортаємо
        qA(root,'*').forEach(el=>{
          const name = el.tagName.toLowerCase();
          if (!opts.wlAllowed.has(name)) unwrap(el);
        });
      } else if (opts.removeInline){
        // якщо WL не активний, працює звичайна опція «видалити inline-стилі»
        qA(root,'[style]').forEach(el=>el.removeAttribute('style'));
      }

      // Прибрати порожні елементи
      if (opts.removeEmpty){
        let changed;
        const isBlank = (el)=> (!el.textContent || el.textContent.replace(/\u00A0|\s/g,'')==='') && !el.firstElementChild;
        do{
          changed=false;
          qA(root,'*').forEach(el=>{ if(isBlank(el)){ el.remove(); changed=true; } });
        }while(changed);
      }

      // Текстові заміни (&nbsp; → пробіл, стиснути)
      html = root.innerHTML;
      if (opts.nbspToSpace){
        html = html.replace(/&nbsp;|\u00A0/g,' ');
        html = html.replace(/ {2,}/g,' ');
      }

      // Пошук/заміна
      const rows = Array.from(findBox.querySelectorAll('.find-row'));
      for (const row of rows){
        const [f,r] = row.querySelectorAll('input');
        if (!f.value) continue;
        const esc = f.value.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        html = html.replace(new RegExp(esc,'g'), r.value);
      }

      // Повертаємо до DOM для «однорядкової» серіалізації
      const doc2 = parser.parseFromString(`<div id="__root">${html}</div>`, 'text/html');
      const root2 = doc2.getElementById('__root');

      // Серіалізуємо «по одному тегу на рядок», без переносів усередині тегу
      codeArea.value = oneLineSerialize(root2);
    });

    // Початковий підказ — не чіпав
    editor.innerHTML = '<p><strong>Ласкаво просимо!</strong> Вставте текст ліворуч. Праворуч з’явиться HTML-код. Оберіть опції і натисніть <em>Очистити</em>.</p>';
    syncToCode();
  </script>
</body>
</html>
